(()=>{var _e=Object.defineProperty;var Rt=e=>_e(e,"__esModule",{value:!0});var Q=(e,t)=>{Rt(e);for(var r in t)_e(e,r,{get:t[r],enumerable:!0})};var Se=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)};var _=(e,t,r)=>(Se(e,t,"read from private field"),r?r.call(e):t.get(e)),J=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},he=(e,t,r,i)=>(Se(e,t,"write to private field"),i?i.call(e,r):t.set(e,r),r);var A=1e-6,R=typeof Float32Array!="undefined"?Float32Array:Array,F=Math.random;var En=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var d={};Q(d,{add:()=>Qt,adjoint:()=>Vt,clone:()=>Lt,copy:()=>Dt,create:()=>Pt,determinant:()=>kt,equals:()=>rr,exactEquals:()=>tr,frob:()=>Zt,fromMat2d:()=>Xt,fromMat4:()=>It,fromQuat:()=>Ht,fromRotation:()=>qt,fromScaling:()=>Wt,fromTranslation:()=>Yt,fromValues:()=>Ut,identity:()=>Ft,invert:()=>Ct,mul:()=>ir,multiply:()=>we,multiplyScalar:()=>Jt,multiplyScalarAndAdd:()=>er,normalFromMat4:()=>jt,projection:()=>$t,rotate:()=>Nt,scale:()=>zt,set:()=>Gt,str:()=>Kt,sub:()=>nr,subtract:()=>Ee,translate:()=>Ot,transpose:()=>Bt});function Pt(){var e=new R(9);return R!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function It(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e}function Lt(e){var t=new R(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function Dt(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function Ut(e,t,r,i,n,o,a,s,c){var u=new R(9);return u[0]=e,u[1]=t,u[2]=r,u[3]=i,u[4]=n,u[5]=o,u[6]=a,u[7]=s,u[8]=c,u}function Gt(e,t,r,i,n,o,a,s,c,u){return e[0]=t,e[1]=r,e[2]=i,e[3]=n,e[4]=o,e[5]=a,e[6]=s,e[7]=c,e[8]=u,e}function Ft(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function Bt(e,t){if(e===t){var r=t[1],i=t[2],n=t[5];e[1]=t[3],e[2]=t[6],e[3]=r,e[5]=t[7],e[6]=i,e[7]=n}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e}function Ct(e,t){var r=t[0],i=t[1],n=t[2],o=t[3],a=t[4],s=t[5],c=t[6],u=t[7],h=t[8],m=h*a-s*u,p=-h*o+s*c,l=u*o-a*c,v=r*m+i*p+n*l;return v?(v=1/v,e[0]=m*v,e[1]=(-h*i+n*u)*v,e[2]=(s*i-n*a)*v,e[3]=p*v,e[4]=(h*r-n*c)*v,e[5]=(-s*r+n*o)*v,e[6]=l*v,e[7]=(-u*r+i*c)*v,e[8]=(a*r-i*o)*v,e):null}function Vt(e,t){var r=t[0],i=t[1],n=t[2],o=t[3],a=t[4],s=t[5],c=t[6],u=t[7],h=t[8];return e[0]=a*h-s*u,e[1]=n*u-i*h,e[2]=i*s-n*a,e[3]=s*c-o*h,e[4]=r*h-n*c,e[5]=n*o-r*s,e[6]=o*u-a*c,e[7]=i*c-r*u,e[8]=r*a-i*o,e}function kt(e){var t=e[0],r=e[1],i=e[2],n=e[3],o=e[4],a=e[5],s=e[6],c=e[7],u=e[8];return t*(u*o-a*c)+r*(-u*n+a*s)+i*(c*n-o*s)}function we(e,t,r){var i=t[0],n=t[1],o=t[2],a=t[3],s=t[4],c=t[5],u=t[6],h=t[7],m=t[8],p=r[0],l=r[1],v=r[2],y=r[3],x=r[4],f=r[5],g=r[6],b=r[7],w=r[8];return e[0]=p*i+l*a+v*u,e[1]=p*n+l*s+v*h,e[2]=p*o+l*c+v*m,e[3]=y*i+x*a+f*u,e[4]=y*n+x*s+f*h,e[5]=y*o+x*c+f*m,e[6]=g*i+b*a+w*u,e[7]=g*n+b*s+w*h,e[8]=g*o+b*c+w*m,e}function Ot(e,t,r){var i=t[0],n=t[1],o=t[2],a=t[3],s=t[4],c=t[5],u=t[6],h=t[7],m=t[8],p=r[0],l=r[1];return e[0]=i,e[1]=n,e[2]=o,e[3]=a,e[4]=s,e[5]=c,e[6]=p*i+l*a+u,e[7]=p*n+l*s+h,e[8]=p*o+l*c+m,e}function Nt(e,t,r){var i=t[0],n=t[1],o=t[2],a=t[3],s=t[4],c=t[5],u=t[6],h=t[7],m=t[8],p=Math.sin(r),l=Math.cos(r);return e[0]=l*i+p*a,e[1]=l*n+p*s,e[2]=l*o+p*c,e[3]=l*a-p*i,e[4]=l*s-p*n,e[5]=l*c-p*o,e[6]=u,e[7]=h,e[8]=m,e}function zt(e,t,r){var i=r[0],n=r[1];return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=n*t[3],e[4]=n*t[4],e[5]=n*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function Yt(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e}function qt(e,t){var r=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=r,e[2]=0,e[3]=-r,e[4]=i,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function Wt(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function Xt(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e}function Ht(e,t){var r=t[0],i=t[1],n=t[2],o=t[3],a=r+r,s=i+i,c=n+n,u=r*a,h=i*a,m=i*s,p=n*a,l=n*s,v=n*c,y=o*a,x=o*s,f=o*c;return e[0]=1-m-v,e[3]=h-f,e[6]=p+x,e[1]=h+f,e[4]=1-u-v,e[7]=l-y,e[2]=p-x,e[5]=l+y,e[8]=1-u-m,e}function jt(e,t){var r=t[0],i=t[1],n=t[2],o=t[3],a=t[4],s=t[5],c=t[6],u=t[7],h=t[8],m=t[9],p=t[10],l=t[11],v=t[12],y=t[13],x=t[14],f=t[15],g=r*s-i*a,b=r*c-n*a,w=r*u-o*a,I=i*c-n*s,oe=i*u-o*s,ae=n*u-o*c,se=h*y-m*v,ce=h*x-p*v,X=h*f-l*v,ue=m*x-p*y,H=m*f-l*y,j=p*f-l*x,D=g*j-b*H+w*ue+I*X-oe*ce+ae*se;return D?(D=1/D,e[0]=(s*j-c*H+u*ue)*D,e[1]=(c*X-a*j-u*ce)*D,e[2]=(a*H-s*X+u*se)*D,e[3]=(n*H-i*j-o*ue)*D,e[4]=(r*j-n*X+o*ce)*D,e[5]=(i*X-r*H-o*se)*D,e[6]=(y*ae-x*oe+f*I)*D,e[7]=(x*w-v*ae-f*b)*D,e[8]=(v*oe-y*w+f*g)*D,e):null}function $t(e,t,r){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/r,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e}function Kt(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"}function Zt(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])}function Qt(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e[8]=t[8]+r[8],e}function Ee(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e[6]=t[6]-r[6],e[7]=t[7]-r[7],e[8]=t[8]-r[8],e}function Jt(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*r,e}function er(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e[3]=t[3]+r[3]*i,e[4]=t[4]+r[4]*i,e[5]=t[5]+r[5]*i,e[6]=t[6]+r[6]*i,e[7]=t[7]+r[7]*i,e[8]=t[8]+r[8]*i,e}function tr(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]}function rr(e,t){var r=e[0],i=e[1],n=e[2],o=e[3],a=e[4],s=e[5],c=e[6],u=e[7],h=e[8],m=t[0],p=t[1],l=t[2],v=t[3],y=t[4],x=t[5],f=t[6],g=t[7],b=t[8];return Math.abs(r-m)<=A*Math.max(1,Math.abs(r),Math.abs(m))&&Math.abs(i-p)<=A*Math.max(1,Math.abs(i),Math.abs(p))&&Math.abs(n-l)<=A*Math.max(1,Math.abs(n),Math.abs(l))&&Math.abs(o-v)<=A*Math.max(1,Math.abs(o),Math.abs(v))&&Math.abs(a-y)<=A*Math.max(1,Math.abs(a),Math.abs(y))&&Math.abs(s-x)<=A*Math.max(1,Math.abs(s),Math.abs(x))&&Math.abs(c-f)<=A*Math.max(1,Math.abs(c),Math.abs(f))&&Math.abs(u-g)<=A*Math.max(1,Math.abs(u),Math.abs(g))&&Math.abs(h-b)<=A*Math.max(1,Math.abs(h),Math.abs(b))}var ir=we,nr=Ee;var P={};Q(P,{add:()=>ur,angle:()=>Lr,bezier:()=>Sr,ceil:()=>hr,clone:()=>or,copy:()=>sr,create:()=>Ae,cross:()=>Tr,dist:()=>kr,distance:()=>Le,div:()=>Vr,divide:()=>Ie,dot:()=>Ge,equals:()=>Fr,exactEquals:()=>Gr,floor:()=>fr,forEach:()=>Yr,fromValues:()=>ar,hermite:()=>_r,inverse:()=>xr,len:()=>Nr,length:()=>Me,lerp:()=>br,max:()=>mr,min:()=>lr,mul:()=>Cr,multiply:()=>Pe,negate:()=>gr,normalize:()=>yr,random:()=>wr,rotateX:()=>Rr,rotateY:()=>Pr,rotateZ:()=>Ir,round:()=>pr,scale:()=>dr,scaleAndAdd:()=>vr,set:()=>cr,sqrDist:()=>Or,sqrLen:()=>zr,squaredDistance:()=>De,squaredLength:()=>Ue,str:()=>Ur,sub:()=>Br,subtract:()=>Re,transformMat3:()=>Ar,transformMat4:()=>Er,transformQuat:()=>Mr,zero:()=>Dr});function Ae(){var e=new R(3);return R!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function or(e){var t=new R(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function Me(e){var t=e[0],r=e[1],i=e[2];return Math.hypot(t,r,i)}function ar(e,t,r){var i=new R(3);return i[0]=e,i[1]=t,i[2]=r,i}function sr(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function cr(e,t,r,i){return e[0]=t,e[1]=r,e[2]=i,e}function ur(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}function Re(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}function Pe(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e}function Ie(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e}function hr(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}function fr(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e}function lr(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e}function mr(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e}function pr(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e}function dr(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function vr(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e}function Le(e,t){var r=t[0]-e[0],i=t[1]-e[1],n=t[2]-e[2];return Math.hypot(r,i,n)}function De(e,t){var r=t[0]-e[0],i=t[1]-e[1],n=t[2]-e[2];return r*r+i*i+n*n}function Ue(e){var t=e[0],r=e[1],i=e[2];return t*t+r*r+i*i}function gr(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function xr(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e}function yr(e,t){var r=t[0],i=t[1],n=t[2],o=r*r+i*i+n*n;return o>0&&(o=1/Math.sqrt(o)),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e}function Ge(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function Tr(e,t,r){var i=t[0],n=t[1],o=t[2],a=r[0],s=r[1],c=r[2];return e[0]=n*c-o*s,e[1]=o*a-i*c,e[2]=i*s-n*a,e}function br(e,t,r,i){var n=t[0],o=t[1],a=t[2];return e[0]=n+i*(r[0]-n),e[1]=o+i*(r[1]-o),e[2]=a+i*(r[2]-a),e}function _r(e,t,r,i,n,o){var a=o*o,s=a*(2*o-3)+1,c=a*(o-2)+o,u=a*(o-1),h=a*(3-2*o);return e[0]=t[0]*s+r[0]*c+i[0]*u+n[0]*h,e[1]=t[1]*s+r[1]*c+i[1]*u+n[1]*h,e[2]=t[2]*s+r[2]*c+i[2]*u+n[2]*h,e}function Sr(e,t,r,i,n,o){var a=1-o,s=a*a,c=o*o,u=s*a,h=3*o*s,m=3*c*a,p=c*o;return e[0]=t[0]*u+r[0]*h+i[0]*m+n[0]*p,e[1]=t[1]*u+r[1]*h+i[1]*m+n[1]*p,e[2]=t[2]*u+r[2]*h+i[2]*m+n[2]*p,e}function wr(e,t){t=t||1;var r=F()*2*Math.PI,i=F()*2-1,n=Math.sqrt(1-i*i)*t;return e[0]=Math.cos(r)*n,e[1]=Math.sin(r)*n,e[2]=i*t,e}function Er(e,t,r){var i=t[0],n=t[1],o=t[2],a=r[3]*i+r[7]*n+r[11]*o+r[15];return a=a||1,e[0]=(r[0]*i+r[4]*n+r[8]*o+r[12])/a,e[1]=(r[1]*i+r[5]*n+r[9]*o+r[13])/a,e[2]=(r[2]*i+r[6]*n+r[10]*o+r[14])/a,e}function Ar(e,t,r){var i=t[0],n=t[1],o=t[2];return e[0]=i*r[0]+n*r[3]+o*r[6],e[1]=i*r[1]+n*r[4]+o*r[7],e[2]=i*r[2]+n*r[5]+o*r[8],e}function Mr(e,t,r){var i=r[0],n=r[1],o=r[2],a=r[3],s=t[0],c=t[1],u=t[2],h=n*u-o*c,m=o*s-i*u,p=i*c-n*s,l=n*p-o*m,v=o*h-i*p,y=i*m-n*h,x=a*2;return h*=x,m*=x,p*=x,l*=2,v*=2,y*=2,e[0]=s+h+l,e[1]=c+m+v,e[2]=u+p+y,e}function Rr(e,t,r,i){var n=[],o=[];return n[0]=t[0]-r[0],n[1]=t[1]-r[1],n[2]=t[2]-r[2],o[0]=n[0],o[1]=n[1]*Math.cos(i)-n[2]*Math.sin(i),o[2]=n[1]*Math.sin(i)+n[2]*Math.cos(i),e[0]=o[0]+r[0],e[1]=o[1]+r[1],e[2]=o[2]+r[2],e}function Pr(e,t,r,i){var n=[],o=[];return n[0]=t[0]-r[0],n[1]=t[1]-r[1],n[2]=t[2]-r[2],o[0]=n[2]*Math.sin(i)+n[0]*Math.cos(i),o[1]=n[1],o[2]=n[2]*Math.cos(i)-n[0]*Math.sin(i),e[0]=o[0]+r[0],e[1]=o[1]+r[1],e[2]=o[2]+r[2],e}function Ir(e,t,r,i){var n=[],o=[];return n[0]=t[0]-r[0],n[1]=t[1]-r[1],n[2]=t[2]-r[2],o[0]=n[0]*Math.cos(i)-n[1]*Math.sin(i),o[1]=n[0]*Math.sin(i)+n[1]*Math.cos(i),o[2]=n[2],e[0]=o[0]+r[0],e[1]=o[1]+r[1],e[2]=o[2]+r[2],e}function Lr(e,t){var r=e[0],i=e[1],n=e[2],o=t[0],a=t[1],s=t[2],c=Math.sqrt(r*r+i*i+n*n),u=Math.sqrt(o*o+a*a+s*s),h=c*u,m=h&&Ge(e,t)/h;return Math.acos(Math.min(Math.max(m,-1),1))}function Dr(e){return e[0]=0,e[1]=0,e[2]=0,e}function Ur(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"}function Gr(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function Fr(e,t){var r=e[0],i=e[1],n=e[2],o=t[0],a=t[1],s=t[2];return Math.abs(r-o)<=A*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-a)<=A*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(n-s)<=A*Math.max(1,Math.abs(n),Math.abs(s))}var Br=Re,Cr=Pe,Vr=Ie,kr=Le,Or=De,Nr=Me,zr=Ue,Yr=function(){var e=Ae();return function(t,r,i,n,o,a){var s,c;for(r||(r=3),i||(i=0),n?c=Math.min(n*r+i,t.length):c=t.length,s=i;s<c;s+=r)e[0]=t[s],e[1]=t[s+1],e[2]=t[s+2],o(e,e,a),t[s]=e[0],t[s+1]=e[1],t[s+2]=e[2];return t}}();var L={};Q(L,{add:()=>jr,ceil:()=>$r,clone:()=>qr,copy:()=>Xr,create:()=>Fe,cross:()=>ai,dist:()=>xi,distance:()=>ke,div:()=>gi,divide:()=>Ve,dot:()=>oi,equals:()=>pi,exactEquals:()=>mi,floor:()=>Kr,forEach:()=>_i,fromValues:()=>Wr,inverse:()=>ii,len:()=>Ti,length:()=>Ne,lerp:()=>si,max:()=>Qr,min:()=>Zr,mul:()=>vi,multiply:()=>Ce,negate:()=>ri,normalize:()=>ni,random:()=>ci,round:()=>Jr,scale:()=>ei,scaleAndAdd:()=>ti,set:()=>Hr,sqrDist:()=>yi,sqrLen:()=>bi,squaredDistance:()=>Oe,squaredLength:()=>ze,str:()=>li,sub:()=>di,subtract:()=>Be,transformMat4:()=>ui,transformQuat:()=>hi,zero:()=>fi});function Fe(){var e=new R(4);return R!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function qr(e){var t=new R(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function Wr(e,t,r,i){var n=new R(4);return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n}function Xr(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function Hr(e,t,r,i,n){return e[0]=t,e[1]=r,e[2]=i,e[3]=n,e}function jr(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e}function Be(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e}function Ce(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e[3]=t[3]*r[3],e}function Ve(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e[3]=t[3]/r[3],e}function $r(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e}function Kr(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e}function Zr(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e[3]=Math.min(t[3],r[3]),e}function Qr(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e[3]=Math.max(t[3],r[3]),e}function Jr(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e}function ei(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e}function ti(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e[3]=t[3]+r[3]*i,e}function ke(e,t){var r=t[0]-e[0],i=t[1]-e[1],n=t[2]-e[2],o=t[3]-e[3];return Math.hypot(r,i,n,o)}function Oe(e,t){var r=t[0]-e[0],i=t[1]-e[1],n=t[2]-e[2],o=t[3]-e[3];return r*r+i*i+n*n+o*o}function Ne(e){var t=e[0],r=e[1],i=e[2],n=e[3];return Math.hypot(t,r,i,n)}function ze(e){var t=e[0],r=e[1],i=e[2],n=e[3];return t*t+r*r+i*i+n*n}function ri(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e}function ii(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e}function ni(e,t){var r=t[0],i=t[1],n=t[2],o=t[3],a=r*r+i*i+n*n+o*o;return a>0&&(a=1/Math.sqrt(a)),e[0]=r*a,e[1]=i*a,e[2]=n*a,e[3]=o*a,e}function oi(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function ai(e,t,r,i){var n=r[0]*i[1]-r[1]*i[0],o=r[0]*i[2]-r[2]*i[0],a=r[0]*i[3]-r[3]*i[0],s=r[1]*i[2]-r[2]*i[1],c=r[1]*i[3]-r[3]*i[1],u=r[2]*i[3]-r[3]*i[2],h=t[0],m=t[1],p=t[2],l=t[3];return e[0]=m*u-p*c+l*s,e[1]=-(h*u)+p*a-l*o,e[2]=h*c-m*a+l*n,e[3]=-(h*s)+m*o-p*n,e}function si(e,t,r,i){var n=t[0],o=t[1],a=t[2],s=t[3];return e[0]=n+i*(r[0]-n),e[1]=o+i*(r[1]-o),e[2]=a+i*(r[2]-a),e[3]=s+i*(r[3]-s),e}function ci(e,t){t=t||1;var r,i,n,o,a,s;do r=F()*2-1,i=F()*2-1,a=r*r+i*i;while(a>=1);do n=F()*2-1,o=F()*2-1,s=n*n+o*o;while(s>=1);var c=Math.sqrt((1-a)/s);return e[0]=t*r,e[1]=t*i,e[2]=t*n*c,e[3]=t*o*c,e}function ui(e,t,r){var i=t[0],n=t[1],o=t[2],a=t[3];return e[0]=r[0]*i+r[4]*n+r[8]*o+r[12]*a,e[1]=r[1]*i+r[5]*n+r[9]*o+r[13]*a,e[2]=r[2]*i+r[6]*n+r[10]*o+r[14]*a,e[3]=r[3]*i+r[7]*n+r[11]*o+r[15]*a,e}function hi(e,t,r){var i=t[0],n=t[1],o=t[2],a=r[0],s=r[1],c=r[2],u=r[3],h=u*i+s*o-c*n,m=u*n+c*i-a*o,p=u*o+a*n-s*i,l=-a*i-s*n-c*o;return e[0]=h*u+l*-a+m*-c-p*-s,e[1]=m*u+l*-s+p*-a-h*-c,e[2]=p*u+l*-c+h*-s-m*-a,e[3]=t[3],e}function fi(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e}function li(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}function mi(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function pi(e,t){var r=e[0],i=e[1],n=e[2],o=e[3],a=t[0],s=t[1],c=t[2],u=t[3];return Math.abs(r-a)<=A*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(i-s)<=A*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(n-c)<=A*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(o-u)<=A*Math.max(1,Math.abs(o),Math.abs(u))}var di=Be,vi=Ce,gi=Ve,xi=ke,yi=Oe,Ti=Ne,bi=ze,_i=function(){var e=Fe();return function(t,r,i,n,o,a){var s,c;for(r||(r=4),i||(i=0),n?c=Math.min(n*r+i,t.length):c=t.length,s=i;s<c;s+=r)e[0]=t[s],e[1]=t[s+1],e[2]=t[s+2],e[3]=t[s+3],o(e,e,a),t[s]=e[0],t[s+1]=e[1],t[s+2]=e[2],t[s+3]=e[3];return t}}();var T={};Q(T,{add:()=>Mi,angle:()=>Hi,ceil:()=>Ri,clone:()=>Si,copy:()=>Ei,create:()=>Ye,cross:()=>ki,dist:()=>rn,distance:()=>He,div:()=>tn,divide:()=>Xe,dot:()=>Vi,equals:()=>Zi,exactEquals:()=>Ki,floor:()=>Pi,forEach:()=>an,fromValues:()=>wi,inverse:()=>Bi,len:()=>Qi,length:()=>$e,lerp:()=>Oi,max:()=>Li,min:()=>Ii,mul:()=>en,multiply:()=>We,negate:()=>Fi,normalize:()=>Ci,random:()=>Ni,rotate:()=>Xi,round:()=>Di,scale:()=>Ui,scaleAndAdd:()=>Gi,set:()=>Ai,sqrDist:()=>nn,sqrLen:()=>on,squaredDistance:()=>je,squaredLength:()=>Ke,str:()=>$i,sub:()=>Ji,subtract:()=>qe,transformMat2:()=>zi,transformMat2d:()=>Yi,transformMat3:()=>qi,transformMat4:()=>Wi,zero:()=>ji});function Ye(){var e=new R(2);return R!=Float32Array&&(e[0]=0,e[1]=0),e}function Si(e){var t=new R(2);return t[0]=e[0],t[1]=e[1],t}function wi(e,t){var r=new R(2);return r[0]=e,r[1]=t,r}function Ei(e,t){return e[0]=t[0],e[1]=t[1],e}function Ai(e,t,r){return e[0]=t,e[1]=r,e}function Mi(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e}function qe(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e}function We(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e}function Xe(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e}function Ri(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function Pi(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function Ii(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e}function Li(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e}function Di(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function Ui(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e}function Gi(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e}function He(e,t){var r=t[0]-e[0],i=t[1]-e[1];return Math.hypot(r,i)}function je(e,t){var r=t[0]-e[0],i=t[1]-e[1];return r*r+i*i}function $e(e){var t=e[0],r=e[1];return Math.hypot(t,r)}function Ke(e){var t=e[0],r=e[1];return t*t+r*r}function Fi(e,t){return e[0]=-t[0],e[1]=-t[1],e}function Bi(e,t){return e[0]=1/t[0],e[1]=1/t[1],e}function Ci(e,t){var r=t[0],i=t[1],n=r*r+i*i;return n>0&&(n=1/Math.sqrt(n)),e[0]=t[0]*n,e[1]=t[1]*n,e}function Vi(e,t){return e[0]*t[0]+e[1]*t[1]}function ki(e,t,r){var i=t[0]*r[1]-t[1]*r[0];return e[0]=e[1]=0,e[2]=i,e}function Oi(e,t,r,i){var n=t[0],o=t[1];return e[0]=n+i*(r[0]-n),e[1]=o+i*(r[1]-o),e}function Ni(e,t){t=t||1;var r=F()*2*Math.PI;return e[0]=Math.cos(r)*t,e[1]=Math.sin(r)*t,e}function zi(e,t,r){var i=t[0],n=t[1];return e[0]=r[0]*i+r[2]*n,e[1]=r[1]*i+r[3]*n,e}function Yi(e,t,r){var i=t[0],n=t[1];return e[0]=r[0]*i+r[2]*n+r[4],e[1]=r[1]*i+r[3]*n+r[5],e}function qi(e,t,r){var i=t[0],n=t[1];return e[0]=r[0]*i+r[3]*n+r[6],e[1]=r[1]*i+r[4]*n+r[7],e}function Wi(e,t,r){var i=t[0],n=t[1];return e[0]=r[0]*i+r[4]*n+r[12],e[1]=r[1]*i+r[5]*n+r[13],e}function Xi(e,t,r,i){var n=t[0]-r[0],o=t[1]-r[1],a=Math.sin(i),s=Math.cos(i);return e[0]=n*s-o*a+r[0],e[1]=n*a+o*s+r[1],e}function Hi(e,t){var r=e[0],i=e[1],n=t[0],o=t[1],a=Math.sqrt(r*r+i*i)*Math.sqrt(n*n+o*o),s=a&&(r*n+i*o)/a;return Math.acos(Math.min(Math.max(s,-1),1))}function ji(e){return e[0]=0,e[1]=0,e}function $i(e){return"vec2("+e[0]+", "+e[1]+")"}function Ki(e,t){return e[0]===t[0]&&e[1]===t[1]}function Zi(e,t){var r=e[0],i=e[1],n=t[0],o=t[1];return Math.abs(r-n)<=A*Math.max(1,Math.abs(r),Math.abs(n))&&Math.abs(i-o)<=A*Math.max(1,Math.abs(i),Math.abs(o))}var Qi=$e,Ji=qe,en=We,tn=Xe,rn=He,nn=je,on=Ke,an=function(){var e=Ye();return function(t,r,i,n,o,a){var s,c;for(r||(r=2),i||(i=0),n?c=Math.min(n*r+i,t.length):c=t.length,s=i;s<c;s+=r)e[0]=t[s],e[1]=t[s+1],o(e,e,a),t[s]=e[0],t[s+1]=e[1];return t}}();function fe(e){let t=document.createElement("canvas");t.setAttribute("width",e.screen.width.toString()),t.setAttribute("height",e.screen.height.toString()),t.style.imageRendering="pixelated";let r=t.getContext("webgl2",{alpha:!1,premultipliedAlpha:!1});if(!r)return console.error("Unable to initialize WebGL. Your browser or machine may not support it."),null;let i=document.createElement("canvas");i.width=e.offscreenCanvas.width,i.height=e.offscreenCanvas.height;let n=i.getContext("2d",{willReadFrequently:!0});if(!n)return console.error("Unable to initialize OffscreenCanvas. Your browser or machine may not support it."),null;let o=null,a={gl:r,offscreen:n,canvas:t,getGamepad:()=>o!==null?navigator.getGamepads()[o]:null,keys:{down:new Set,pressed:new Set},mouse:{position:T.create(),wheel:T.create(),down:[],clicked:[]},touches:{down:new Map,ended:new Map},screen:{...e.screen,toScreenSpace:(f,g)=>L.set(f,g[0]/e.screen.height,g[1]/e.screen.width,g[2]/e.screen.height,g[3]/e.screen.width)}},s=1;window.addEventListener("gamepadconnected",f=>{o=f.gamepad.index}),window.addEventListener("gamepaddisconnected",f=>{o=null}),window.addEventListener("keydown",f=>{a.keys.down.add(f.key),(f.altKey||f.shiftKey||f.ctrlKey)&&f.preventDefault()}),window.addEventListener("keyup",f=>{a.keys.down.has(f.key)&&a.keys.pressed.add(f.key),a.keys.down.delete(f.key),(f.altKey||f.shiftKey||f.ctrlKey)&&f.preventDefault()}),t.addEventListener("wheel",f=>{f.deltaMode===WheelEvent.DOM_DELTA_PIXEL&&T.set(a.mouse.wheel,f.deltaX,f.deltaY)}),t.addEventListener("mousemove",f=>{let g=t.getBoundingClientRect();T.set(a.mouse.position,(f.clientX-g.left)/s,(f.clientY-g.top)/s)}),t.addEventListener("mousedown",f=>{a.mouse.down[f.button]=!0}),t.addEventListener("mouseup",f=>{a.mouse.down[f.button]&&(a.mouse.clicked[f.button]=!0),a.mouse.down[f.button]=!1}),t.addEventListener("contextmenu",f=>{f.preventDefault()}),t.addEventListener("touchstart",f=>{let g=t.getBoundingClientRect();for(let b=0;b<f.changedTouches.length;++b){let w=f.changedTouches[b],I=T.fromValues((w.clientX-g.left)/s,(w.clientY-g.top)/s);I[0]>=0&&I[1]>=0&&I[0]<=a.screen.width&&I[1]<=a.screen.height&&a.touches.down.set(w.identifier,I)}}),t.addEventListener("touchmove",f=>{let g=t.getBoundingClientRect();for(let b=0;b<f.changedTouches.length;++b){let w=f.changedTouches[b],I=a.touches.down.get(w.identifier);I&&T.set(I,(w.clientX-g.left)/s,(w.clientY-g.top)/s)}}),t.addEventListener("touchend",f=>{let g=t.getBoundingClientRect();for(let b=0;b<f.changedTouches.length;++b){let w=f.changedTouches[b],I=a.touches.down.get(w.identifier);I&&(T.set(I,(w.clientX-g.left)/s,(w.clientY-g.top)/s),a.touches.down.delete(w.identifier),a.touches.ended.set(w.identifier,I))}}),t.addEventListener("touchcancel",f=>{for(let g=0;g<f.changedTouches.length;++g){let b=f.changedTouches[g];a.touches.down.get(b.identifier)&&a.touches.down.delete(b.identifier)}});let c=performance.now(),u=!1,h=null,m=async()=>{let f=localStorage.getItem(e.saveKey);try{h=await e.start(a,f?JSON.parse(f):void 0),c=performance.now()}catch(g){console.warn(g),h=await e.start(a),c=performance.now()}};t.addEventListener("webglcontextlost",f=>{f.preventDefault(),u=!0,console.warn("WebGL context lost, saving state..."),h&&localStorage.setItem(e.saveKey,JSON.stringify(e.save(h)))},!1),t.addEventListener("webglcontextrestored",f=>{f.preventDefault(),a.gl=t.getContext("webgl2"),console.warn("WebGL context restored, loading state..."),m().then(g=>{u=!1})},!1),m();let p=0,l=null,v=()=>{if(h){let f=performance.now(),g=f-c;for(c=f,p+=g;p>=e.fixedUpdate;)e.update(a,h,e.fixedUpdate),a.mouse.clicked=[],T.set(a.mouse.wheel,0,0),a.touches.ended.clear(),a.keys.pressed.clear(),p-=e.fixedUpdate;u||e.draw(a,h,g)}l=requestAnimationFrame(v)};l=requestAnimationFrame(v);let y=()=>{document.visibilityState==="hidden"?(h&&(console.warn("Visibility changing, saving state..."),localStorage.setItem(e.saveKey,JSON.stringify(e.save(h)))),l&&cancelAnimationFrame(l)):(c=performance.now(),p=0,l=requestAnimationFrame(v))};window.addEventListener("visibilitychange",y);let x=()=>{s=Math.max(1,Math.min(Math.floor(window.innerWidth/e.screen.width),Math.floor(window.innerHeight/e.screen.height))),t&&(t.style.width=s*e.screen.width+"px",t.style.height=s*e.screen.height+"px")};return x(),window.addEventListener("resize",x),t}var S=Symbol();function Ze(e){return new Promise((t,r)=>{let i=new Image;i.onload=()=>t(i),i.onerror=n=>r(n),i.src=e})}async function W(e,t,r){let i=await Ze(t);return{[S]:Je(e,i,r),width:i.width,height:i.height}}async function Qe(e,t,r){let i=await Ze(t);return{image:i,[S]:Je(e,i,r),width:i.width,height:i.height}}function Je(e,t,r){let i=e.gl.createTexture();return e.gl.activeTexture(e.gl.TEXTURE0),e.gl.bindTexture(e.gl.TEXTURE_2D,i),e.gl.pixelStorei(e.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_WRAP_S,r?.wrap||e.gl.CLAMP_TO_EDGE),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_WRAP_T,r?.wrap||e.gl.CLAMP_TO_EDGE),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_MIN_FILTER,r?.wrap||e.gl.LINEAR),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_MAG_FILTER,r?.wrap||e.gl.LINEAR),e.gl.texImage2D(e.gl.TEXTURE_2D,0,e.gl.RGBA,e.gl.RGBA,e.gl.UNSIGNED_BYTE,t),e.gl.bindTexture(e.gl.TEXTURE_2D,null),i}var ee=P.set(P.create(),0,1,0),te=P.set(P.create(),0,0,1),le=P.cross(P.create(),ee,te),sn=d.set(d.create(),ee[0],le[0],te[0],ee[1],le[1],te[1],ee[2],le[2],te[2]),et=d.transpose(d.create(),sn);async function me(e,t,r){let i=await r(e,t);return{...Object.keys(t.sprites).reduce((n,o)=>{let a=t.sprites[o],s=a.frames.map(c=>L.fromValues(c.top,c.right,c.bottom,c.left));return n[o]={width:a.width,height:a.height,frames:s,draw:(c,u,h=0)=>(c.setTextures(i),c.draw(u,s[Math.floor(h)%s.length]),n[o])},n},{})}}var re=class{#e;#t;#i;constructor(t,r,i){this.frameRate=i,this.frame=0,this.#e=t,this.#i=r,this.#t=t[r]}tick(t){this.frame+=t*this.frameRate,this.frame>this.#t.frames.length&&(this.frame-=this.#t.frames.length)}getSprite(){return this.#t}getSpriteName(){return this.#i}setSprite(t){let r=this.#e[t];r!==this.#t&&(this.#t=r,this.#i=t,this.frame=0)}setSpriteOrTick(t,r){let i=this.#e[t];i!==this.#t?(this.#t=i,this.#i=t,this.frame=0):this.tick(r)}draw(t,r,i=0){this.#t.draw(t,r,this.frame+i)}};var z=d.create();d.scale(z,z,[1,-1]);d.translate(z,z,[-1,-1]);d.scale(z,z,[2,2]);var V=z,G=class{#e;#t;#i;#n;#r;constructor(t){this.#t=t,this.#r="",this.#n=null,this.#i=this.#t.createVertexArray();let r=new Float32Array([0,0,1,0,0,1,1,1]);this.#e=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.#e),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null)}#o(t,r){let i={position:t.inAttributes[r.position].location};return{...i,hash:`${i.position}`}}bind(t,r,i){let n=this.#o(t,r);this.#t.bindVertexArray(this.#i),(this.#r!==n.hash||this.#n!==null)&&(this.#t.bindBuffer(this.#t.ARRAY_BUFFER,this.#e),this.#t.enableVertexAttribArray(n.position),this.#t.vertexAttribPointer(n.position,2,this.#t.FLOAT,!1,0,0),this.#r=n.hash,this.#n=null),i({draw:()=>{this.#t.drawArrays(this.#t.TRIANGLE_STRIP,0,4)}}),this.#t.bindVertexArray(null)}bindInstances(t,r,i,n){let o=this.#o(t,r),a=i.getAttributesHash(t),s=`${o.hash}:${a}`;this.#t.bindVertexArray(this.#i),(this.#r!==s||this.#n!==i)&&(this.#t.bindBuffer(this.#t.ARRAY_BUFFER,this.#e),this.#t.enableVertexAttribArray(o.position),this.#t.vertexAttribPointer(o.position,2,this.#t.FLOAT,!1,0,0),this.#r=s,this.#n=i.bind(t));let c=i.getInstanceCount();n({draw:()=>{this.#t.drawArraysInstanced(this.#t.TRIANGLE_STRIP,0,4,c)}}),this.#t.bindVertexArray(null)}};var U=class{#e;#t;constructor(t,r,i){this.#e=t,this.#t=t.createProgram(),this.inAttributes={},this.outAttributes={},this.uniforms={};let n=t.createShader(t.VERTEX_SHADER);t.shaderSource(n,r.src),t.compileShader(n);let o="";if(!t.getShaderParameter(n,t.COMPILE_STATUS)){let u=t.getShaderInfoLog(n);u&&(o+=u+`
`)}let a=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(a,i.src),t.compileShader(a),!t.getShaderParameter(a,t.COMPILE_STATUS)){let u=t.getShaderInfoLog(a);u&&(o+=u+`
`)}if(t.attachShader(this.#t,n),t.attachShader(this.#t,a),t.linkProgram(this.#t),!t.getProgramParameter(this.#t,t.LINK_STATUS)){let u=t.getProgramInfoLog(this.#t);u&&(o+=`
Linker: (${r.name}, ${i.name}): ${u}`)}if(o!=="")throw new Error(`Shader compilation of [${r.name}, ${i.name}] failed:
${o}`);let s=t.getProgramParameter(this.#t,t.ACTIVE_ATTRIBUTES);for(let u=0;u<s;++u){let h=t.getActiveAttrib(this.#t,u);if(h){let m=h.name;m in r.inAttributes&&(this.inAttributes[m]={location:t.getAttribLocation(this.#t,h.name),type:r.inAttributes[m].type})}}Object.keys(i.outAttributes).forEach(u=>{let h=t.getFragDataLocation(this.#t,u);this.outAttributes[u]={location:h,type:i.outAttributes[u].type}});let c=t.getProgramParameter(this.#t,t.ACTIVE_UNIFORMS);for(let u=0;u<c;++u){let h=t.getActiveUniform(this.#t,u);if(h){let m=h.name;(m in r.uniforms||m in i.uniforms)&&(this.uniforms[h.name]={location:t.getUniformLocation(this.#t,h.name),type:r.uniforms[m]||i.uniforms[m]})}}}use(t){this.#e.useProgram(this.#t),t(this),this.#e.useProgram(null)}setUniforms(t){let r=0;for(let i in t){let n=t[i],o=this.uniforms[i];if(o)o.type==="sampler2D"?(this.#e.activeTexture(this.#e[`TEXTURE${r}`]),this.#e.bindTexture(this.#e.TEXTURE_2D,n),this.#e.uniform1i(o.location,r++)):o.type==="float"?this.#e.uniform1f(o.location,n):o.type==="vec2"?this.#e.uniform2fv(o.location,n):o.type==="vec3"?this.#e.uniform3fv(o.location,n):o.type==="vec4"?this.#e.uniform4fv(o.location,n):o.type==="mat2"?this.#e.uniformMatrix2fv(o.location,!1,n):o.type==="mat3"?this.#e.uniformMatrix3fv(o.location,!1,n):o.type==="mat4"?this.#e.uniformMatrix4fv(o.location,!1,n):o.type==="int"&&this.#e.uniform1i(o.location,n);else continue}return this}},k=class{#e;#t;#i;#n;#r=[];constructor(t,r,i){this.#t=t,this.#e=this.#t.createBuffer(),this.#n=0,this.#i=0,this.#r=[];for(let[n,o]of Object.entries(i)){let a=r.inAttributes[n].type;if(a==="float")this.#r.push({col:1,row:1,size:1,name:n,load:(s,c,u)=>{s[c]=o(u)}});else{let s={name:n,load:(c,u,h)=>c.set(o(h),u)};switch(a){case"vec2":this.#r.push({col:1,row:2,size:2,...s});break;case"vec3":this.#r.push({col:1,row:3,size:3,...s});break;case"vec4":this.#r.push({col:1,row:4,size:4,...s});break;case"mat2":this.#r.push({col:2,row:2,size:4,...s});break;case"mat3":this.#r.push({col:3,row:3,size:9,...s});break;case"mat4":this.#r.push({col:4,row:4,size:16,...s});break;default:throw new Error("Unknown instance buffer attribute type")}}this.#i+=this.#r[this.#r.length-1].size}}load(t){this.#n=t.length;let r=new Float32Array(t.length*this.#i),i=0;for(let n=0;n<t.length;++n)for(let o=0;o<this.#r.length;++o)this.#r[o].load(r,i,t[n]),i+=this.#r[o].size;return this.#t.bindBuffer(this.#t.ARRAY_BUFFER,this.#e),this.#t.bufferData(this.#t.ARRAY_BUFFER,r,this.#t.STREAM_DRAW),this.#t.bindBuffer(this.#t.ARRAY_BUFFER,null),this}getInstanceCount(){return this.#n}getAttributesHash(t){return this.#r.map(r=>t.inAttributes[r.name].location).join("-")}bind(t){this.#t.bindBuffer(this.#t.ARRAY_BUFFER,this.#e);let r=0;for(let i=0;i<this.#r.length;++i){let n=t.inAttributes[this.#r[i].name].location;for(let o=0;o<this.#r[i].col;++o)this.#t.enableVertexAttribArray(n+o),this.#t.vertexAttribPointer(n+o,this.#r[i].row,this.#t.FLOAT,!1,this.#i*4,r),this.#t.vertexAttribDivisor(n+o,1),r+=this.#r[i].row*4}return this}},M,Y,N,q=class{constructor(t,r,i){J(this,M,void 0);J(this,Y,void 0);he(this,M,t),he(this,Y,_(this,M).createFramebuffer()),_(this,M).bindFramebuffer(_(this,M).FRAMEBUFFER,_(this,Y));let n=[];Object.entries(i).forEach(([o,a])=>{let s=r.outAttributes[o].location;_(this,M).framebufferTexture2D(_(this,M).FRAMEBUFFER,_(this,M)[`COLOR_ATTACHMENT${s}`],_(this,M).TEXTURE_2D,a,0),n.push(_(this,M)[`COLOR_ATTACHMENT${s}`])}),_(this,M).drawBuffers(n.sort((o,a)=>o-a)),_(this,M).bindFramebuffer(_(this,M).FRAMEBUFFER,null)}bind(t){_(q,N).push(_(this,Y)),_(this,M).bindFramebuffer(_(this,M).FRAMEBUFFER,_(this,Y)),t(),_(q,N).pop(),_(q,N).length?_(this,M).bindFramebuffer(_(this,M).FRAMEBUFFER,_(q,N)[_(q,N).length-1]):_(this,M).bindFramebuffer(_(this,M).FRAMEBUFFER,null)}},B=q;M=new WeakMap,Y=new WeakMap,N=new WeakMap,J(B,N,[]);function O(e,t,r,i,n,o,a){let s=e.createTexture();return e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,a?.wrap||e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,a?.wrap||e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,a?.filter||e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,a?.filter||e.LINEAR),e.texImage2D(e.TEXTURE_2D,0,t,n,o,0,r,i,null),e.bindTexture(e.TEXTURE_2D,null),s}var tt;(function(e){})(tt||(tt={}));var cn={src:`#version 300 es
in vec2 a_position;in mat3 a_uv;in mat3 a_mvp;out vec2 v_texCoord;void main(){vec3 A=a_uv*vec3(a_position,1.);vec3 B=a_mvp*vec3(a_position,1.);v_texCoord=A.xy;gl_Position=vec4(B.xy,0.,1.);}`,name:"deferred-sprite.vert",inAttributes:{a_position:{type:"vec2"},a_uv:{type:"mat3"},a_mvp:{type:"mat3"}},outAttributes:{},uniforms:{}},rt=cn;var it;(function(e){})(it||(it={}));var un={src:`#version 300 es
precision mediump float;in vec2 v_texCoord;uniform sampler2D u_diffuseTexture;uniform sampler2D u_normalTexture;uniform sampler2D u_specularTexture;uniform sampler2D u_emissiveTexture;layout(location=0)out vec4 o_normal;layout(location=1)out vec4 o_albedo;layout(location=2)out vec4 o_specular;layout(location=3)out vec4 o_lighting;layout(location=4)out vec4 o_mask;void main(){vec4 A=texture(u_diffuseTexture,v_texCoord);vec3 B=texture(u_normalTexture,v_texCoord).xyz;float C=texture(u_specularTexture,v_texCoord).x;vec3 D=texture(u_emissiveTexture,v_texCoord).xyz;float E=A.w<0.99?0.:1.;o_albedo=vec4(A.xyz*E,E);o_normal=vec4(B,E);o_specular=vec4(C,C,C,E);o_lighting=vec4(D,E);o_mask=vec4(E,E,E,1.);}`,name:"deferred-sprite.frag",inAttributes:{},outAttributes:{o_normal:{type:"vec4",location:0},o_albedo:{type:"vec4",location:1},o_specular:{type:"vec4",location:2},o_lighting:{type:"vec4",location:3},o_mask:{type:"vec4",location:4}},uniforms:{u_diffuseTexture:"sampler2D",u_normalTexture:"sampler2D",u_specularTexture:"sampler2D",u_emissiveTexture:"sampler2D"}},nt=un;var ot;(function(e){})(ot||(ot={}));var hn={src:`#version 300 es
in vec2 a_position;in mat3 a_mvp;in mat3 a_uv;in vec3 a_ambient;in vec3 a_diffuse;in vec3 a_direction;in float a_radius;out vec3 v_ambient;out vec3 v_diffuse;out vec3 v_direction;out float v_radius;out vec2 v_texCoord;void main(){vec3 A=a_uv*vec3(a_position,1.);v_texCoord=A.xy;v_ambient=a_ambient;v_diffuse=a_diffuse;v_direction=a_direction;v_radius=a_radius;vec3 B=a_mvp*vec3(a_position,1.);gl_Position=vec4(B.xy,0.,1.);}`,name:"deferred-lighting.vert",inAttributes:{a_position:{type:"vec2"},a_mvp:{type:"mat3"},a_uv:{type:"mat3"},a_ambient:{type:"vec3"},a_diffuse:{type:"vec3"},a_direction:{type:"vec3"},a_radius:{type:"float"}},outAttributes:{},uniforms:{}},at=hn;var $;(function(r){r[r.LIGHTING_MODE_DIRECTIONAL=0]="LIGHTING_MODE_DIRECTIONAL",r[r.LIGHTING_MODE_POINT=1]="LIGHTING_MODE_POINT"})($||($={}));var fn={src:`#version 300 es
precision mediump float;in vec2 v_texCoord;in vec3 v_ambient;in vec3 v_diffuse;in vec3 v_direction;in float v_radius;uniform vec3 u_viewDirection;uniform int u_lightingMode;uniform sampler2D u_albedoTexture;uniform sampler2D u_normalTexture;uniform sampler2D u_specularTexture;uniform mat3 u_toTangentSpace;const int A=0;const int B=1;const float C=2.;const float D=32.;layout(location=0)out vec4 o_lighting;void main(){vec3 E=normalize(texture(u_normalTexture,v_texCoord).rgb*2.-1.);vec3 F=texture(u_albedoTexture,v_texCoord).rgb;vec3 G=texture(u_specularTexture,v_texCoord).rgb;vec3 H=v_ambient*F;vec3 I=u_lightingMode==A?v_direction:vec3(v_texCoord,0.)-v_direction;I.y*=u_lightingMode==A?1.:-1.;float J=u_lightingMode==A?1.:pow(1.-min(v_radius,length(I))/v_radius,C);vec3 K=normalize(I*-1.)*u_toTangentSpace;float L=max(dot(E,K),0.);vec3 M=F*v_diffuse*L*J;vec3 N=normalize(K+(u_viewDirection*u_toTangentSpace));float O=max(dot(E,N),0.);float P=pow(O,D);vec3 Q=v_diffuse*P*G*J;o_lighting=vec4(H+M+Q,1.);}`,name:"deferred-lighting.frag",inAttributes:{},outAttributes:{o_lighting:{type:"vec4",location:0}},uniforms:{u_viewDirection:"vec3",u_lightingMode:"int",u_albedoTexture:"sampler2D",u_normalTexture:"sampler2D",u_specularTexture:"sampler2D",u_toTangentSpace:"mat3"}},st=fn;var pe=class extends re{},ln=P.fromValues(0,0,0),K=d.create();d.scale(K,K,[1,-1]);d.mul(K,K,V);var Z=d.create();d.translate(Z,Z,[0,0]);d.scale(Z,Z,[1,1]);async function de(e,t){let[r,i,n,o]=await Promise.all([W(e,t.urls.diffuse),W(e,t.urls.normal),W(e,t.urls.specular),W(e,t.urls.emissive)]);return{diffuseTexture:r,normalTexture:i,specularTexture:n,emissiveTexture:o}}var ve=class{#e;#t;#i;#n;#r;#o;#s;#c;#a;#h;#u;#f;#l;constructor(t){this.#e=t,this.#t=new U(t,rt,nt),this.#i=new k(t,this.#t,{a_mvp:r=>r.mvp,a_uv:r=>r.uv}),this.#n=[],this.#r=new U(t,at,st),this.#o=new k(t,this.#r,{a_mvp:r=>r.mvp,a_uv:r=>r.uv,a_ambient:r=>r.ambient,a_diffuse:r=>r.diffuse,a_direction:r=>r.direction,a_radius:r=>r.radius}),this.#s=[],this.#c=[],this.#h=new G(t),this.#a=null,this.#u=null,this.#f=this.#l=0}use(t,r,i){if(!this.#u||t.width!==this.#f||t.height!==this.#l){this.#l=t.height,this.#f=t.width;let o={normal:O(this.#e,this.#e.RGBA,this.#e.RGBA,this.#e.UNSIGNED_BYTE,t.width,t.height),albedo:O(this.#e,this.#e.RGBA,this.#e.RGBA,this.#e.UNSIGNED_BYTE,t.width,t.height),specular:O(this.#e,this.#e.RGBA,this.#e.RGBA,this.#e.UNSIGNED_BYTE,t.width,t.height),lighting:{[S]:O(this.#e,this.#e.RGBA,this.#e.RGBA,this.#e.UNSIGNED_BYTE,t.width,t.height),width:t.width,height:t.height},mask:{[S]:O(this.#e,this.#e.RGBA,this.#e.RGBA,this.#e.UNSIGNED_BYTE,t.width,t.height),width:t.width,height:t.height}};this.#u={...o,maskFrameBuffer:new B(this.#e,this.#t,{o_normal:o.normal,o_albedo:o.albedo,o_specular:o.specular,o_lighting:o.lighting[S],o_mask:o.mask[S]}),noMaskFrameBuffer:new B(this.#e,this.#t,{o_normal:o.normal,o_albedo:o.albedo,o_specular:o.specular,o_lighting:o.lighting[S],o_mask:null}),lightingFrameBuffer:new B(this.#e,this.#r,{o_lighting:o.lighting[S]})}}let n=this.#u;n.maskFrameBuffer.bind(()=>{this.#e.viewport(0,0,this.#f,this.#l),this.#e.clear(this.#e.COLOR_BUFFER_BIT|this.#e.DEPTH_BUFFER_BIT),this.#t.use(()=>{r(this,0),this.#m()})}),n.noMaskFrameBuffer.bind(()=>{i(n.mask),this.#t.use(()=>{r(this,1),this.#m()})}),n.lightingFrameBuffer.bind(()=>{let o=this.#e.getParameter(this.#e.BLEND),a=this.#e.getParameter(this.#e.BLEND_SRC_ALPHA),s=this.#e.getParameter(this.#e.BLEND_DST_ALPHA);this.#e.enable(this.#e.BLEND),this.#e.blendFunc(this.#e.ONE,this.#e.ONE),this.#r.use(c=>{c.setUniforms({u_albedoTexture:n.albedo,u_normalTexture:n.normal,u_specularTexture:n.specular,u_toTangentSpace:et,u_viewDirection:P.fromValues(0,0,-1)}),this.#s.length&&(c.setUniforms({u_lightingMode:$.LIGHTING_MODE_DIRECTIONAL}),this.#h.bindInstances(c,{position:"a_position"},this.#o.load(this.#s),u=>u.draw()),this.#s.length=0),this.#c.length&&(c.setUniforms({u_lightingMode:$.LIGHTING_MODE_POINT}),this.#h.bindInstances(c,{position:"a_position"},this.#o.load(this.#c),u=>u.draw()),this.#c.length=0)}),o||this.#e.disable(this.#e.BLEND),this.#e.blendFunc(a,s)})}addDirectionalLight(t){return this.#s.push({mvp:K,uv:Z,ambient:t.ambient,diffuse:t.diffuse,direction:t.direction,radius:0}),this}addPointLight(t){if(t.position[2]>=t.radius)return this;let r=Math.sqrt(t.radius*t.radius-t.position[2]*t.position[2]),i=d.create();d.translate(i,i,[t.position[0]-r,t.position[1]-r]),d.scale(i,i,[r*2,r*2]),d.mul(i,V,i);let n=d.create();return d.translate(n,n,[t.position[0]-r,1-t.position[1]+r]),d.scale(n,n,[r*2,r*2]),d.scale(n,n,[1,-1]),this.#c.push({mvp:i,uv:n,ambient:ln,diffuse:t.diffuse,direction:P.fromValues(t.position[0],1-t.position[1],t.position[2]),radius:t.radius}),this}getLightingTexture(){return this.#u?.lighting}setTextures(t){return t===this.#a?this:(this.#n.length&&this.#m(),this.#a=t,this.#t.setUniforms({u_diffuseTexture:t.diffuseTexture[S],u_normalTexture:t.normalTexture[S],u_specularTexture:t.specularTexture[S],u_emissiveTexture:t.emissiveTexture[S]}),this)}draw(t,r){if(this.#a){let i=d.create();d.translate(i,i,[t[3],t[0]]),d.scale(i,i,[t[1]-t[3],t[2]-t[0]]),d.multiply(i,V,i);let n=d.create();d.translate(n,n,[r[3]/this.#a.diffuseTexture.width,r[0]/this.#a.diffuseTexture.height]),d.scale(n,n,[(r[1]-r[3])/this.#a.diffuseTexture.width,(r[2]-r[0])/this.#a.diffuseTexture.height]),this.#n.push({mvp:i,uv:n})}return this}#m(){!this.#n.length||(this.#h.bindInstances(this.#t,{position:"a_position"},this.#i.load(this.#n),t=>t.draw()),this.#n.length=0,this.#a=null)}};var ct;(function(e){})(ct||(ct={}));var mn={src:`#version 300 es
in vec2 a_position;in mat3 a_uv;in mat3 a_mvp;out vec2 v_texCoord;void main(){vec3 A=a_uv*vec3(a_position,1.);vec3 B=a_mvp*vec3(a_position,1.);v_texCoord=A.xy;gl_Position=vec4(B.xy,0.,1.);}`,name:"sprite.vert",inAttributes:{a_position:{type:"vec2"},a_uv:{type:"mat3"},a_mvp:{type:"mat3"}},outAttributes:{},uniforms:{}},ut=mn;var ht;(function(e){})(ht||(ht={}));var pn={src:`#version 300 es
precision mediump float;in vec2 v_texCoord;uniform sampler2D u_texture;out vec4 outColor;void main(){outColor=texture(u_texture,v_texCoord);}`,name:"sprite.frag",inAttributes:{},outAttributes:{outColor:{type:"vec4"}},uniforms:{u_texture:"sampler2D"}},ft=pn;var ge=class{#e;#t;#i;#n;#r;#o;constructor(t){this.#e=t,this.#t=new U(this.#e,ut,ft),this.#i=new k(this.#e,this.#t,{a_mvp:r=>r.mvp,a_uv:r=>r.uv}),this.#n=new G(this.#e),this.#o=[],this.#r=null}use(t){this.#t.use(()=>{t(this),this.#s()})}setTextures(t){return t===this.#r?this:(this.#o.length&&this.#s(),this.#r=t,this.#t.setUniforms({u_texture:t[S]}),this)}draw(t,r){if(this.#r){let i=d.create();d.translate(i,i,[t[3],t[0]]),d.scale(i,i,[t[1]-t[3],t[2]-t[0]]),d.multiply(i,V,i);let n=d.create();d.translate(n,n,[r[3]/this.#r.width,r[0]/this.#r.height]),d.scale(n,n,[(r[1]-r[3])/this.#r.width,(r[2]-r[0])/this.#r.height]),this.#o.push({mvp:i,uv:n})}return this}#s(){this.#n.bindInstances(this.#t,{position:"a_position"},this.#i.load(this.#o),t=>{t.draw()}),this.#o=[],this.#r=null}};var lt;(function(e){})(lt||(lt={}));var dn={src:`#version 300 es
in vec2 a_position;out vec2 v_texCoord;void main(){v_texCoord=a_position;gl_Position=vec4(a_position*2.-1.,0.,1.);}`,name:"quad.vert",inAttributes:{a_position:{type:"vec2"}},outAttributes:{},uniforms:{}},ie=dn;var mt;(function(e){})(mt||(mt={}));var vn={src:`#version 300 es
precision mediump float;layout(location=0)out vec4 o_normal;layout(location=1)out vec4 o_albedo;layout(location=2)out vec4 o_specular;layout(location=3)out vec4 o_lighting;layout(location=4)out vec4 o_mask;in vec2 v_texCoord;uniform sampler2D u_mask;uniform sampler2D u_depth;void main(){vec4 A=texture(u_mask,v_texCoord);float B=texture(u_depth,v_texCoord).r*0.5;float C=1.-A.r;o_albedo=vec4(30./255.+B,104./255.+B*2.,204./255.+B,C);o_normal=vec4(vec3(0.5,0.5,1),C);o_specular=vec4(1.,1.,1.,C);o_lighting=vec4(0.,0.,0.,0.);o_mask=vec4(0.,0.,0.,0.);}`,name:"water.frag",inAttributes:{},outAttributes:{o_normal:{type:"vec4",location:0},o_albedo:{type:"vec4",location:1},o_specular:{type:"vec4",location:2},o_lighting:{type:"vec4",location:3},o_mask:{type:"vec4",location:4}},uniforms:{u_mask:"sampler2D",u_depth:"sampler2D"}},pt=vn;var xe=class{#e;#t;#i;constructor(t){this.#e=t,this.#t=new U(this.#e,ie,pt),this.#i=new G(this.#e)}draw(t,r){return this.#t.use(i=>{i.setUniforms({u_mask:t[S],u_depth:r[S]}),this.#i.bind(this.#t,{position:"a_position"},n=>{n.draw()})}),this}};var dt;(function(t){t[t.KERNEL_SIZE=9]="KERNEL_SIZE"})(dt||(dt={}));var gn={src:`#version 300 es
precision mediump float;uniform sampler2D u_blur;uniform vec2 u_blurSize;uniform vec2 u_blurDirection;uniform float u_blurStrength;in vec2 v_texCoord;out vec4 o_color;
#define A  9
const float B[A]=float[](0.0625,0.0625,0.125,0.125,0.25,0.125,0.125,0.0625,0.0625);const int C=A/2;void main(){vec4 D=vec4(0.);for(int E=0;E<A;++E){vec2 F=v_texCoord+((vec2(E-C,E-C)*u_blurDirection*u_blurStrength)/u_blurSize);vec4 G=texture(u_blur,F);D+=G*B[E];}o_color=D;}`,name:"gaussian-blur.frag",inAttributes:{},outAttributes:{o_color:{type:"vec4"}},uniforms:{u_blur:"sampler2D",u_blurSize:"vec2",u_blurDirection:"vec2",u_blurStrength:"float"}},vt=gn;var ye=class{#e;#t;#i;#n;constructor(t){this.#e=t,this.#t=new U(this.#e,ie,vt),this.#i=new G(this.#e),this.#n=null}draw(t,r){if(!this.#n||this.#n.textures[0].width!==t.width*r||this.#n.textures[0].height!==t.height*r){let n=[];for(let a=0;a<2;a++)n.push({[S]:O(this.#e,this.#e.RGBA,this.#e.RGBA,this.#e.UNSIGNED_BYTE,t.width*r,t.height*r),width:t.width*r,height:t.height*r});let o=new B(this.#e,this.#t,{o_color:n[1][S]});this.#n={textures:n,frameBuffers:[o,new B(this.#e,this.#t,{o_color:n[0][S]}),o]}}let i=this.#n;return this.#t.use(n=>{this.#e.viewport(0,0,t.width*r,t.height*r),r!==1&&(n.setUniforms({u_blur:t[S],u_blurSize:[t.width,t.height],u_blurDirection:[0,0],u_blurStrength:1}),i.frameBuffers[0].bind(()=>{this.#e.clear(this.#e.COLOR_BUFFER_BIT|this.#e.DEPTH_BUFFER_BIT),this.#i.bind(this.#t,{position:"a_position"},a=>{a.draw()})}));let o=r!==1?i.textures[1]:t;n.setUniforms({u_blur:o[S],u_blurSize:[o.width,o.height],u_blurDirection:[0,1]}),i.frameBuffers[1].bind(()=>{this.#e.clear(this.#e.COLOR_BUFFER_BIT|this.#e.DEPTH_BUFFER_BIT),this.#i.bind(this.#t,{position:"a_position"},a=>{a.draw()})}),n.setUniforms({u_blur:i.textures[0][S],u_blurSize:[i.textures[0].width,i.textures[0].height],u_blurDirection:[1,0]}),i.frameBuffers[2].bind(()=>{this.#e.clear(this.#e.COLOR_BUFFER_BIT|this.#e.DEPTH_BUFFER_BIT),this.#i.bind(this.#t,{position:"a_position"},a=>{a.draw()})}),this.#e.viewport(0,0,t.width,t.height)}),this}getBlurTexture(){return this.#n.textures[1]}};var gt;(function(e){})(gt||(gt={}));var xn={src:`#version 300 es
in vec2 a_position;in vec4 a_color;in mat3 a_mvp;out vec4 v_color;void main(){v_color=a_color;vec3 A=a_mvp*vec3(a_position,1.);gl_Position=vec4(A.xy,0.,1.);}`,name:"solid.vert",inAttributes:{a_position:{type:"vec2"},a_color:{type:"vec4"},a_mvp:{type:"mat3"}},outAttributes:{},uniforms:{}},xt=xn;var yt;(function(e){})(yt||(yt={}));var yn={src:`#version 300 es
precision mediump float;in vec4 v_color;out vec4 outColor;void main(){outColor=v_color;}`,name:"solid.frag",inAttributes:{},outAttributes:{outColor:{type:"vec4"}},uniforms:{}},Tt=yn;var Te=class{#e;#t;#i;#n;#r;constructor(t){this.#e=t,this.#t=new U(this.#e,xt,Tt),this.#i=new k(this.#e,this.#t,{a_mvp:r=>r.mvp,a_color:r=>r.color}),this.#n=new G(this.#e),this.#r=[]}use(t){this.#t.use(()=>{t(this),this.#o()})}draw(t,r){let i=d.create();return d.translate(i,i,[t[3],t[0]]),d.scale(i,i,[t[1]-t[3],t[2]-t[0]]),d.multiply(i,V,i),this.#r.push({mvp:i,color:r}),this}#o(){this.#n.bindInstances(this.#t,{position:"a_position"},this.#i.load(this.#r),t=>t.draw()),this.#r=[]}};var Tn={sprites:{grass_b:{width:16,height:16,frames:[{top:0,left:0,bottom:16,right:16}]},grass_bl:{width:16,height:16,frames:[{top:16,left:0,bottom:32,right:16}]},grass_br:{width:16,height:16,frames:[{top:32,left:0,bottom:48,right:16}]},grass_i_bl:{width:16,height:16,frames:[{top:48,left:0,bottom:64,right:16}]},grass_i_br:{width:16,height:16,frames:[{top:64,left:0,bottom:80,right:16}]},grass_t:{width:16,height:16,frames:[{top:80,left:0,bottom:96,right:16}]},grass_tl:{width:16,height:16,frames:[{top:96,left:0,bottom:112,right:16}]},grass_tr:{width:16,height:16,frames:[{top:112,left:0,bottom:128,right:16}]},grass_i_tl:{width:16,height:16,frames:[{top:128,left:0,bottom:144,right:16}]},grass_i_tr:{width:16,height:16,frames:[{top:144,left:0,bottom:160,right:16}]},grass_l:{width:16,height:16,frames:[{top:160,left:0,bottom:176,right:16}]},grass_r:{width:16,height:16,frames:[{top:176,left:0,bottom:192,right:16}]},grass:{width:16,height:16,frames:[{top:192,left:0,bottom:208,right:16},{top:192,left:16,bottom:208,right:32},{top:192,left:32,bottom:208,right:48},{top:192,left:48,bottom:208,right:64}]},water:{width:16,height:16,frames:[{top:208,left:0,bottom:224,right:16},{top:208,left:16,bottom:224,right:32},{top:208,left:32,bottom:224,right:48},{top:208,left:48,bottom:224,right:64},{top:208,left:64,bottom:224,right:80},{top:208,left:80,bottom:224,right:96},{top:208,left:96,bottom:224,right:112},{top:208,left:112,bottom:224,right:128}]}},urls:{diffuse:"./sprites/overworld-diffuse.png",emissive:"./sprites/overworld-emissive.png",normal:"./sprites/overworld-normal.png",specular:"./sprites/overworld-specular.png"}},bt=Tn;var bn={sprites:{walk_d:{width:16,height:32,frames:[{top:0,left:0,bottom:32,right:16},{top:0,left:16,bottom:32,right:32},{top:0,left:32,bottom:32,right:48},{top:0,left:48,bottom:32,right:64}]},walk_u:{width:16,height:32,frames:[{top:32,left:0,bottom:64,right:16},{top:32,left:16,bottom:64,right:32},{top:32,left:32,bottom:64,right:48},{top:32,left:48,bottom:64,right:64}]},walk_l:{width:16,height:32,frames:[{top:64,left:0,bottom:96,right:16},{top:64,left:16,bottom:96,right:32},{top:64,left:32,bottom:96,right:48},{top:64,left:48,bottom:96,right:64}]},walk_r:{width:16,height:32,frames:[{top:96,left:0,bottom:128,right:16},{top:96,left:16,bottom:128,right:32},{top:96,left:32,bottom:128,right:48},{top:96,left:48,bottom:128,right:64}]}},urls:{diffuse:"./sprites/character-diffuse.png",emissive:"./sprites/character-emissive.png",normal:"./sprites/character-normal.png",specular:"./sprites/character-specular.png"}},_t=bn;var E=16;function be(e,t){return L.set(e,Math.floor(t[0]/E),Math.floor(t[1]/E),Math.floor(t[0])%E,Math.floor(t[1])%E)}var ne=.25,_n=1;function St(e){return{version:1,character:{position:[e.character.position[0],e.character.position[1]],direction:e.character.animator.getSpriteName()}}}async function wt(e,t){if(t&&t.version!==_n)throw new Error(`Invalid save version ${t.version}`);let r=await me(e,bt,de),i=await me(e,_t,de),n={spriteEffect:new ve(e.gl),simpleSpriteEffect:new ge(e.gl),solidEffect:new Te(e.gl),map:await Qe(e,"./images/walkmap.png"),mapBuffer:new ImageData(e.screen.width/E+2,e.screen.height/E+2),overworld:r,character:{sprite:i,animator:new pe(i,t?t.character.direction:"walk_d",8/1e3),position:t?T.fromValues(t.character.position[0],t.character.position[1]):T.fromValues(e.screen.width/2,e.screen.height/2),relativePosition:T.create(),speed:1},waterEffect:new xe(e.gl),blurEffect:new ye(e.gl),animationTimer:0,screen:{...e.screen,absolutePosition:T.create()}};return e.offscreen.drawImage(n.map.image,0,0,n.map.width,n.map.height),n}function Et(e,t,r){let i={},n=e.getGamepad();n&&((n.buttons[12].pressed||Math.min(0,n.axes[1]+ne)<0)&&(i.up=!0),(n.buttons[13].pressed||Math.max(0,n.axes[1]-ne)>0)&&(i.down=!0),(n.buttons[14].pressed||Math.min(0,n.axes[0]+ne)<0)&&(i.left=!0),(n.buttons[15].pressed||Math.max(0,n.axes[0]-ne)>0)&&(i.right=!0)),e.keys.pressed.has("f")&&e.keys.down.has("Control")&&(document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():e.canvas.requestFullscreen()),(e.keys.down.has("w")||e.keys.down.has("ArrowUp"))&&(i.up=!0),(e.keys.down.has("s")||e.keys.down.has("ArrowDown"))&&(i.down=!0),(e.keys.down.has("a")||e.keys.down.has("ArrowLeft"))&&(i.left=!0),(e.keys.down.has("d")||e.keys.down.has("ArrowRight"))&&(i.right=!0);let o=null;i.left?o="walk_l":i.right?o="walk_r":i.up?o="walk_u":i.down&&(o="walk_d"),o&&t.character.animator.setSpriteOrTick(o,r),t.animationTimer+=r/4e3,t.animationTimer>Math.PI*2&&(t.animationTimer-=Math.PI*2);let a=T.create();if(i.left&&a[0]--,i.right&&a[0]++,i.up&&a[1]--,i.down&&a[1]++,T.normalize(a,a),T.scale(a,a,t.character.speed),T.add(a,a,t.character.position),!!1){let u=T.fromValues(t.character.animator.getSprite().width/2,t.character.animator.getSprite().height/2),h=T.fromValues(t.map.width*E,t.map.height*E);T.subtract(h,h,u),T.min(t.character.position,a,h),T.max(t.character.position,t.character.position,u)}t.character.relativePosition[0]=t.character.position[0]<e.screen.width/2?t.character.position[0]:t.character.position[0]>t.map.width*E-e.screen.width/2?t.character.position[0]-t.map.width*E+e.screen.width:e.screen.width/2,t.character.relativePosition[1]=t.character.position[1]<e.screen.height/2?t.character.position[1]:t.character.position[1]>t.map.height*E-e.screen.height/2?t.character.position[1]-t.map.height*E+e.screen.height:e.screen.height/2,T.subtract(t.screen.absolutePosition,t.character.position,t.character.relativePosition);let c=be(L.create(),t.screen.absolutePosition);t.mapBuffer=e.offscreen.getImageData(c[0]-1,c[1]-1,e.screen.width/E+3,e.screen.height/E+3)}function At(e,t,r){e.gl.enable(e.gl.BLEND),e.gl.blendFunc(e.gl.SRC_ALPHA,e.gl.ONE_MINUS_SRC_ALPHA);let i=be(L.create(),t.screen.absolutePosition),n=Math.sin(t.animationTimer);n=Math.min(1,n+.5);let o=Math.pow(Math.max(0,n),8);t.spriteEffect.addDirectionalLight({ambient:P.fromValues(.2+o*.3,.2+o*.3,.4+o*.1),direction:P.fromValues(Math.cos(t.animationTimer),o*.5,-1),diffuse:P.fromValues(Math.pow(o,.25)*(1-o)+o*.5,o*.5,o*.45)}).addPointLight({diffuse:P.fromValues(.6*(1-o),.6*(1-o),.3*(1-o)),position:P.fromValues(e.mouse.position[0]/e.screen.width,e.mouse.position[1]/e.screen.height,.1),radius:.5}).use({width:e.screen.width,height:e.screen.height},(a,s)=>{if(s===0)for(let c=-1;c<=(e.screen.width+2)/E;++c)for(let u=-1;u<=(e.screen.height+2)/E;++u){let h=c+i[0],m=u+i[1],p=Sn(h,m),l=e.screen.toScreenSpace(L.create(),L.fromValues(u*E-i[3],c*E+E-i[2],u*E+E-i[3],c*E-i[2]));if(C(c,u,t)!==0){let v=C(c,u-1,t)===0,y=C(c-1,u,t)===0,x=C(c,u+1,t)===0,f=C(c+1,u,t)===0,g=C(c-1,u-1,t)===0,b=C(c+1,u-1,t)===0,w=C(c-1,u+1,t)===0,I=C(c+1,u+1,t)===0;v&&y?t.overworld.grass_tl.draw(a,l):v&&f?t.overworld.grass_tr.draw(a,l):v&&!y&&!f?t.overworld.grass_t.draw(a,l):g&&!y&&!v?t.overworld.grass_i_tl.draw(a,l):b&&!f&&!v?t.overworld.grass_i_tr.draw(a,l):y&&!v&&!x?t.overworld.grass_l.draw(a,l):x&&y?t.overworld.grass_bl.draw(a,l):x&&f?t.overworld.grass_br.draw(a,l):x&&!y&&!f?t.overworld.grass_b.draw(a,l):w&&!y&&!x?t.overworld.grass_i_bl.draw(a,l):I&&!f&&!x?t.overworld.grass_i_br.draw(a,l):f&&!v&&!x?t.overworld.grass_r.draw(a,l):t.overworld.grass.draw(a,l,p)}}else{let c=T.fromValues(t.character.animator.getSprite().width/2,t.character.animator.getSprite().height/2);t.character.animator.draw(a,e.screen.toScreenSpace(L.create(),L.fromValues(Math.floor(t.character.relativePosition[1])-c[1],Math.floor(t.character.relativePosition[0])+c[0],Math.floor(t.character.relativePosition[1])+c[1],Math.floor(t.character.relativePosition[0])-c[0])))}},a=>{t.blurEffect.draw(a,.5),t.waterEffect.draw(a,t.blurEffect.getBlurTexture())}),t.simpleSpriteEffect.use(a=>{let s=t.spriteEffect.getLightingTexture();s&&(a.setTextures(s),a.draw(L.fromValues(1,1,0,0),L.fromValues(0,s.width,s.height,0)))})}function C(e,t,r){let i=r.screen.width/E+3;return r.mapBuffer.data[4*(i*(t+1)+e+1)]}function Sn(e,t){let r=48271,i=2147483647,n=i/r,o=i%r,a=r*(e%n)-o*Math.floor(e/n);return a>=0?e=a:e=a+i,a=r*(t%n)-o*Math.floor(t/n),a>=0?t=a:t=a+i,e^t}var Mt=fe({fixedUpdate:1e3/60,saveKey:"pixelheart",save:St,start:wt,update:Et,draw:At,screen:{width:320,height:208},offscreenCanvas:{width:1024,height:1024}});Mt&&document.getElementById("root")?.appendChild(Mt);})();
//# sourceMappingURL=index.js.map
