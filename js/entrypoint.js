var Ce=Object.defineProperty;var Br=Object.getOwnPropertyDescriptor;var Cr=Object.getOwnPropertyNames;var Fr=Object.prototype.hasOwnProperty;var _=(e,t)=>()=>(e&&(t=e(e=0)),t);var Z=(e,t)=>{for(var r in t)Ce(e,r,{get:t[r],enumerable:!0})},Nr=(e,t,r,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Cr(t))!Fr.call(e,n)&&n!==r&&Ce(e,n,{get:()=>t[n],enumerable:!(i=Br(t,n))||i.enumerable});return e};var Ur=e=>Nr(Ce({},"__esModule",{value:!0}),e);function U(e){return e>=0?Math.round(e):e%.5===0?Math.floor(e):Math.round(e)}var R,L,z,Ko,jo,se=_(()=>{R=1e-6,L=typeof Float32Array<"u"?Float32Array:Array,z=Math.random;Ko=Math.PI/180,jo=180/Math.PI});var x={};Z(x,{add:()=>ai,adjoint:()=>Wr,clone:()=>Gr,copy:()=>zr,create:()=>Or,determinant:()=>Zr,equals:()=>fi,exactEquals:()=>li,frob:()=>si,fromMat2d:()=>ti,fromMat4:()=>kr,fromQuat:()=>ri,fromRotation:()=>Qr,fromScaling:()=>ei,fromTranslation:()=>Jr,fromValues:()=>Vr,identity:()=>Hr,invert:()=>Xr,mul:()=>ui,multiply:()=>Ye,multiplyScalar:()=>hi,multiplyScalarAndAdd:()=>ci,normalFromMat4:()=>ii,projection:()=>ni,rotate:()=>Kr,scale:()=>jr,set:()=>Yr,str:()=>oi,sub:()=>di,subtract:()=>He,translate:()=>$r,transpose:()=>qr});function Or(){var e=new L(9);return L!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function kr(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e}function Gr(e){var t=new L(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function zr(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function Vr(e,t,r,i,n,o,s,a,c){var h=new L(9);return h[0]=e,h[1]=t,h[2]=r,h[3]=i,h[4]=n,h[5]=o,h[6]=s,h[7]=a,h[8]=c,h}function Yr(e,t,r,i,n,o,s,a,c,h){return e[0]=t,e[1]=r,e[2]=i,e[3]=n,e[4]=o,e[5]=s,e[6]=a,e[7]=c,e[8]=h,e}function Hr(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function qr(e,t){if(e===t){var r=t[1],i=t[2],n=t[5];e[1]=t[3],e[2]=t[6],e[3]=r,e[5]=t[7],e[6]=i,e[7]=n}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e}function Xr(e,t){var r=t[0],i=t[1],n=t[2],o=t[3],s=t[4],a=t[5],c=t[6],h=t[7],l=t[8],u=l*s-a*h,m=-l*o+a*c,v=h*o-s*c,d=r*u+i*m+n*v;return d?(d=1/d,e[0]=u*d,e[1]=(-l*i+n*h)*d,e[2]=(a*i-n*s)*d,e[3]=m*d,e[4]=(l*r-n*c)*d,e[5]=(-a*r+n*o)*d,e[6]=v*d,e[7]=(-h*r+i*c)*d,e[8]=(s*r-i*o)*d,e):null}function Wr(e,t){var r=t[0],i=t[1],n=t[2],o=t[3],s=t[4],a=t[5],c=t[6],h=t[7],l=t[8];return e[0]=s*l-a*h,e[1]=n*h-i*l,e[2]=i*a-n*s,e[3]=a*c-o*l,e[4]=r*l-n*c,e[5]=n*o-r*a,e[6]=o*h-s*c,e[7]=i*c-r*h,e[8]=r*s-i*o,e}function Zr(e){var t=e[0],r=e[1],i=e[2],n=e[3],o=e[4],s=e[5],a=e[6],c=e[7],h=e[8];return t*(h*o-s*c)+r*(-h*n+s*a)+i*(c*n-o*a)}function Ye(e,t,r){var i=t[0],n=t[1],o=t[2],s=t[3],a=t[4],c=t[5],h=t[6],l=t[7],u=t[8],m=r[0],v=r[1],d=r[2],M=r[3],A=r[4],I=r[5],k=r[6],F=r[7],Y=r[8];return e[0]=m*i+v*s+d*h,e[1]=m*n+v*a+d*l,e[2]=m*o+v*c+d*u,e[3]=M*i+A*s+I*h,e[4]=M*n+A*a+I*l,e[5]=M*o+A*c+I*u,e[6]=k*i+F*s+Y*h,e[7]=k*n+F*a+Y*l,e[8]=k*o+F*c+Y*u,e}function $r(e,t,r){var i=t[0],n=t[1],o=t[2],s=t[3],a=t[4],c=t[5],h=t[6],l=t[7],u=t[8],m=r[0],v=r[1];return e[0]=i,e[1]=n,e[2]=o,e[3]=s,e[4]=a,e[5]=c,e[6]=m*i+v*s+h,e[7]=m*n+v*a+l,e[8]=m*o+v*c+u,e}function Kr(e,t,r){var i=t[0],n=t[1],o=t[2],s=t[3],a=t[4],c=t[5],h=t[6],l=t[7],u=t[8],m=Math.sin(r),v=Math.cos(r);return e[0]=v*i+m*s,e[1]=v*n+m*a,e[2]=v*o+m*c,e[3]=v*s-m*i,e[4]=v*a-m*n,e[5]=v*c-m*o,e[6]=h,e[7]=l,e[8]=u,e}function jr(e,t,r){var i=r[0],n=r[1];return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=n*t[3],e[4]=n*t[4],e[5]=n*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function Jr(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e}function Qr(e,t){var r=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=r,e[2]=0,e[3]=-r,e[4]=i,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function ei(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function ti(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e}function ri(e,t){var r=t[0],i=t[1],n=t[2],o=t[3],s=r+r,a=i+i,c=n+n,h=r*s,l=i*s,u=i*a,m=n*s,v=n*a,d=n*c,M=o*s,A=o*a,I=o*c;return e[0]=1-u-d,e[3]=l-I,e[6]=m+A,e[1]=l+I,e[4]=1-h-d,e[7]=v-M,e[2]=m-A,e[5]=v+M,e[8]=1-h-u,e}function ii(e,t){var r=t[0],i=t[1],n=t[2],o=t[3],s=t[4],a=t[5],c=t[6],h=t[7],l=t[8],u=t[9],m=t[10],v=t[11],d=t[12],M=t[13],A=t[14],I=t[15],k=r*a-i*s,F=r*c-n*s,Y=r*h-o*s,oe=i*c-n*a,j=i*h-o*a,f=n*h-o*c,p=l*M-u*d,b=l*A-m*d,T=l*I-v*d,S=u*A-m*M,H=u*I-v*M,G=m*I-v*A,N=k*G-F*H+Y*S+oe*T-j*b+f*p;return N?(N=1/N,e[0]=(a*G-c*H+h*S)*N,e[1]=(c*T-s*G-h*b)*N,e[2]=(s*H-a*T+h*p)*N,e[3]=(n*H-i*G-o*S)*N,e[4]=(r*G-n*T+o*b)*N,e[5]=(i*T-r*H-o*p)*N,e[6]=(M*f-A*j+I*oe)*N,e[7]=(A*Y-d*f-I*F)*N,e[8]=(d*j-M*Y+I*k)*N,e):null}function ni(e,t,r){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/r,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e}function oi(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"}function si(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]+e[3]*e[3]+e[4]*e[4]+e[5]*e[5]+e[6]*e[6]+e[7]*e[7]+e[8]*e[8])}function ai(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e[8]=t[8]+r[8],e}function He(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e[6]=t[6]-r[6],e[7]=t[7]-r[7],e[8]=t[8]-r[8],e}function hi(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*r,e}function ci(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e[3]=t[3]+r[3]*i,e[4]=t[4]+r[4]*i,e[5]=t[5]+r[5]*i,e[6]=t[6]+r[6]*i,e[7]=t[7]+r[7]*i,e[8]=t[8]+r[8]*i,e}function li(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]}function fi(e,t){var r=e[0],i=e[1],n=e[2],o=e[3],s=e[4],a=e[5],c=e[6],h=e[7],l=e[8],u=t[0],m=t[1],v=t[2],d=t[3],M=t[4],A=t[5],I=t[6],k=t[7],F=t[8];return Math.abs(r-u)<=R*Math.max(1,Math.abs(r),Math.abs(u))&&Math.abs(i-m)<=R*Math.max(1,Math.abs(i),Math.abs(m))&&Math.abs(n-v)<=R*Math.max(1,Math.abs(n),Math.abs(v))&&Math.abs(o-d)<=R*Math.max(1,Math.abs(o),Math.abs(d))&&Math.abs(s-M)<=R*Math.max(1,Math.abs(s),Math.abs(M))&&Math.abs(a-A)<=R*Math.max(1,Math.abs(a),Math.abs(A))&&Math.abs(c-I)<=R*Math.max(1,Math.abs(c),Math.abs(I))&&Math.abs(h-k)<=R*Math.max(1,Math.abs(h),Math.abs(k))&&Math.abs(l-F)<=R*Math.max(1,Math.abs(l),Math.abs(F))}var ui,di,qe=_(()=>{se();ui=Ye,di=He});var P={};Z(P,{add:()=>_i,angle:()=>zi,bezier:()=>Bi,ceil:()=>xi,clone:()=>mi,copy:()=>vi,create:()=>Xe,cross:()=>Ri,dist:()=>$i,distance:()=>je,div:()=>Zi,divide:()=>Ke,dot:()=>Fe,equals:()=>qi,exactEquals:()=>Hi,floor:()=>bi,forEach:()=>Qi,fromValues:()=>pi,hermite:()=>Di,inverse:()=>Ai,len:()=>ji,length:()=>We,lerp:()=>Pi,max:()=>wi,min:()=>Ei,mul:()=>Wi,multiply:()=>$e,negate:()=>yi,normalize:()=>Ii,random:()=>Ci,rotateX:()=>Oi,rotateY:()=>ki,rotateZ:()=>Gi,round:()=>Ti,scale:()=>Mi,scaleAndAdd:()=>Si,set:()=>gi,slerp:()=>Li,sqrDist:()=>Ki,sqrLen:()=>Ji,squaredDistance:()=>Je,squaredLength:()=>Qe,str:()=>Yi,sub:()=>Xi,subtract:()=>Ze,transformMat3:()=>Ni,transformMat4:()=>Fi,transformQuat:()=>Ui,zero:()=>Vi});function Xe(){var e=new L(3);return L!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function mi(e){var t=new L(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function We(e){var t=e[0],r=e[1],i=e[2];return Math.sqrt(t*t+r*r+i*i)}function pi(e,t,r){var i=new L(3);return i[0]=e,i[1]=t,i[2]=r,i}function vi(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function gi(e,t,r,i){return e[0]=t,e[1]=r,e[2]=i,e}function _i(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}function Ze(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}function $e(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e}function Ke(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e}function xi(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}function bi(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e}function Ei(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e}function wi(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e}function Ti(e,t){return e[0]=U(t[0]),e[1]=U(t[1]),e[2]=U(t[2]),e}function Mi(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function Si(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e}function je(e,t){var r=t[0]-e[0],i=t[1]-e[1],n=t[2]-e[2];return Math.sqrt(r*r+i*i+n*n)}function Je(e,t){var r=t[0]-e[0],i=t[1]-e[1],n=t[2]-e[2];return r*r+i*i+n*n}function Qe(e){var t=e[0],r=e[1],i=e[2];return t*t+r*r+i*i}function yi(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function Ai(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e}function Ii(e,t){var r=t[0],i=t[1],n=t[2],o=r*r+i*i+n*n;return o>0&&(o=1/Math.sqrt(o)),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e}function Fe(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function Ri(e,t,r){var i=t[0],n=t[1],o=t[2],s=r[0],a=r[1],c=r[2];return e[0]=n*c-o*a,e[1]=o*s-i*c,e[2]=i*a-n*s,e}function Pi(e,t,r,i){var n=t[0],o=t[1],s=t[2];return e[0]=n+i*(r[0]-n),e[1]=o+i*(r[1]-o),e[2]=s+i*(r[2]-s),e}function Li(e,t,r,i){var n=Math.acos(Math.min(Math.max(Fe(t,r),-1),1)),o=Math.sin(n),s=Math.sin((1-i)*n)/o,a=Math.sin(i*n)/o;return e[0]=s*t[0]+a*r[0],e[1]=s*t[1]+a*r[1],e[2]=s*t[2]+a*r[2],e}function Di(e,t,r,i,n,o){var s=o*o,a=s*(2*o-3)+1,c=s*(o-2)+o,h=s*(o-1),l=s*(3-2*o);return e[0]=t[0]*a+r[0]*c+i[0]*h+n[0]*l,e[1]=t[1]*a+r[1]*c+i[1]*h+n[1]*l,e[2]=t[2]*a+r[2]*c+i[2]*h+n[2]*l,e}function Bi(e,t,r,i,n,o){var s=1-o,a=s*s,c=o*o,h=a*s,l=3*o*a,u=3*c*s,m=c*o;return e[0]=t[0]*h+r[0]*l+i[0]*u+n[0]*m,e[1]=t[1]*h+r[1]*l+i[1]*u+n[1]*m,e[2]=t[2]*h+r[2]*l+i[2]*u+n[2]*m,e}function Ci(e,t){t=t===void 0?1:t;var r=z()*2*Math.PI,i=z()*2-1,n=Math.sqrt(1-i*i)*t;return e[0]=Math.cos(r)*n,e[1]=Math.sin(r)*n,e[2]=i*t,e}function Fi(e,t,r){var i=t[0],n=t[1],o=t[2],s=r[3]*i+r[7]*n+r[11]*o+r[15];return s=s||1,e[0]=(r[0]*i+r[4]*n+r[8]*o+r[12])/s,e[1]=(r[1]*i+r[5]*n+r[9]*o+r[13])/s,e[2]=(r[2]*i+r[6]*n+r[10]*o+r[14])/s,e}function Ni(e,t,r){var i=t[0],n=t[1],o=t[2];return e[0]=i*r[0]+n*r[3]+o*r[6],e[1]=i*r[1]+n*r[4]+o*r[7],e[2]=i*r[2]+n*r[5]+o*r[8],e}function Ui(e,t,r){var i=r[0],n=r[1],o=r[2],s=r[3],a=t[0],c=t[1],h=t[2],l=n*h-o*c,u=o*a-i*h,m=i*c-n*a;return l=l+l,u=u+u,m=m+m,e[0]=a+s*l+n*m-o*u,e[1]=c+s*u+o*l-i*m,e[2]=h+s*m+i*u-n*l,e}function Oi(e,t,r,i){var n=[],o=[];return n[0]=t[0]-r[0],n[1]=t[1]-r[1],n[2]=t[2]-r[2],o[0]=n[0],o[1]=n[1]*Math.cos(i)-n[2]*Math.sin(i),o[2]=n[1]*Math.sin(i)+n[2]*Math.cos(i),e[0]=o[0]+r[0],e[1]=o[1]+r[1],e[2]=o[2]+r[2],e}function ki(e,t,r,i){var n=[],o=[];return n[0]=t[0]-r[0],n[1]=t[1]-r[1],n[2]=t[2]-r[2],o[0]=n[2]*Math.sin(i)+n[0]*Math.cos(i),o[1]=n[1],o[2]=n[2]*Math.cos(i)-n[0]*Math.sin(i),e[0]=o[0]+r[0],e[1]=o[1]+r[1],e[2]=o[2]+r[2],e}function Gi(e,t,r,i){var n=[],o=[];return n[0]=t[0]-r[0],n[1]=t[1]-r[1],n[2]=t[2]-r[2],o[0]=n[0]*Math.cos(i)-n[1]*Math.sin(i),o[1]=n[0]*Math.sin(i)+n[1]*Math.cos(i),o[2]=n[2],e[0]=o[0]+r[0],e[1]=o[1]+r[1],e[2]=o[2]+r[2],e}function zi(e,t){var r=e[0],i=e[1],n=e[2],o=t[0],s=t[1],a=t[2],c=Math.sqrt((r*r+i*i+n*n)*(o*o+s*s+a*a)),h=c&&Fe(e,t)/c;return Math.acos(Math.min(Math.max(h,-1),1))}function Vi(e){return e[0]=0,e[1]=0,e[2]=0,e}function Yi(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"}function Hi(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function qi(e,t){var r=e[0],i=e[1],n=e[2],o=t[0],s=t[1],a=t[2];return Math.abs(r-o)<=R*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-s)<=R*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(n-a)<=R*Math.max(1,Math.abs(n),Math.abs(a))}var Xi,Wi,Zi,$i,Ki,ji,Ji,Qi,et=_(()=>{se();Xi=Ze,Wi=$e,Zi=Ke,$i=je,Ki=Je,ji=We,Ji=Qe,Qi=function(){var e=Xe();return function(t,r,i,n,o,s){var a,c;for(r||(r=3),i||(i=0),n?c=Math.min(n*r+i,t.length):c=t.length,a=i;a<c;a+=r)e[0]=t[a],e[1]=t[a+1],e[2]=t[a+2],o(e,e,s),t[a]=e[0],t[a+1]=e[1],t[a+2]=e[2];return t}}()});var w={};Z(w,{add:()=>on,ceil:()=>sn,clone:()=>en,copy:()=>rn,create:()=>tt,cross:()=>gn,dist:()=>Rn,distance:()=>ot,div:()=>In,divide:()=>nt,dot:()=>vn,equals:()=>Sn,exactEquals:()=>Mn,floor:()=>an,forEach:()=>Bn,fromValues:()=>tn,inverse:()=>mn,len:()=>Ln,length:()=>at,lerp:()=>_n,max:()=>cn,min:()=>hn,mul:()=>An,multiply:()=>it,negate:()=>dn,normalize:()=>pn,random:()=>xn,round:()=>ln,scale:()=>fn,scaleAndAdd:()=>un,set:()=>nn,sqrDist:()=>Pn,sqrLen:()=>Dn,squaredDistance:()=>st,squaredLength:()=>ht,str:()=>Tn,sub:()=>yn,subtract:()=>rt,transformMat4:()=>bn,transformQuat:()=>En,zero:()=>wn});function tt(){var e=new L(4);return L!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function en(e){var t=new L(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function tn(e,t,r,i){var n=new L(4);return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n}function rn(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function nn(e,t,r,i,n){return e[0]=t,e[1]=r,e[2]=i,e[3]=n,e}function on(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e}function rt(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e}function it(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e[3]=t[3]*r[3],e}function nt(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e[3]=t[3]/r[3],e}function sn(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e}function an(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e}function hn(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e[3]=Math.min(t[3],r[3]),e}function cn(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e[3]=Math.max(t[3],r[3]),e}function ln(e,t){return e[0]=U(t[0]),e[1]=U(t[1]),e[2]=U(t[2]),e[3]=U(t[3]),e}function fn(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e}function un(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e[3]=t[3]+r[3]*i,e}function ot(e,t){var r=t[0]-e[0],i=t[1]-e[1],n=t[2]-e[2],o=t[3]-e[3];return Math.sqrt(r*r+i*i+n*n+o*o)}function st(e,t){var r=t[0]-e[0],i=t[1]-e[1],n=t[2]-e[2],o=t[3]-e[3];return r*r+i*i+n*n+o*o}function at(e){var t=e[0],r=e[1],i=e[2],n=e[3];return Math.sqrt(t*t+r*r+i*i+n*n)}function ht(e){var t=e[0],r=e[1],i=e[2],n=e[3];return t*t+r*r+i*i+n*n}function dn(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e}function mn(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e}function pn(e,t){var r=t[0],i=t[1],n=t[2],o=t[3],s=r*r+i*i+n*n+o*o;return s>0&&(s=1/Math.sqrt(s)),e[0]=r*s,e[1]=i*s,e[2]=n*s,e[3]=o*s,e}function vn(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function gn(e,t,r,i){var n=r[0]*i[1]-r[1]*i[0],o=r[0]*i[2]-r[2]*i[0],s=r[0]*i[3]-r[3]*i[0],a=r[1]*i[2]-r[2]*i[1],c=r[1]*i[3]-r[3]*i[1],h=r[2]*i[3]-r[3]*i[2],l=t[0],u=t[1],m=t[2],v=t[3];return e[0]=u*h-m*c+v*a,e[1]=-(l*h)+m*s-v*o,e[2]=l*c-u*s+v*n,e[3]=-(l*a)+u*o-m*n,e}function _n(e,t,r,i){var n=t[0],o=t[1],s=t[2],a=t[3];return e[0]=n+i*(r[0]-n),e[1]=o+i*(r[1]-o),e[2]=s+i*(r[2]-s),e[3]=a+i*(r[3]-a),e}function xn(e,t){t=t===void 0?1:t;var r,i,n,o,s,a,c;c=z(),r=c*2-1,i=(4*z()-2)*Math.sqrt(c*-c+c),s=r*r+i*i,c=z(),n=c*2-1,o=(4*z()-2)*Math.sqrt(c*-c+c),a=n*n+o*o;var h=Math.sqrt((1-s)/a);return e[0]=t*r,e[1]=t*i,e[2]=t*n*h,e[3]=t*o*h,e}function bn(e,t,r){var i=t[0],n=t[1],o=t[2],s=t[3];return e[0]=r[0]*i+r[4]*n+r[8]*o+r[12]*s,e[1]=r[1]*i+r[5]*n+r[9]*o+r[13]*s,e[2]=r[2]*i+r[6]*n+r[10]*o+r[14]*s,e[3]=r[3]*i+r[7]*n+r[11]*o+r[15]*s,e}function En(e,t,r){var i=r[0],n=r[1],o=r[2],s=r[3],a=t[0],c=t[1],h=t[2],l=n*h-o*c,u=o*a-i*h,m=i*c-n*a;return l=l+l,u=u+u,m=m+m,e[0]=a+s*l+n*m-o*u,e[1]=c+s*u+o*l-i*m,e[2]=h+s*m+i*u-n*l,e[3]=t[3],e}function wn(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e}function Tn(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}function Mn(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function Sn(e,t){var r=e[0],i=e[1],n=e[2],o=e[3],s=t[0],a=t[1],c=t[2],h=t[3];return Math.abs(r-s)<=R*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(i-a)<=R*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(n-c)<=R*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(o-h)<=R*Math.max(1,Math.abs(o),Math.abs(h))}var yn,An,In,Rn,Pn,Ln,Dn,Bn,ct=_(()=>{se();yn=rt,An=it,In=nt,Rn=ot,Pn=st,Ln=at,Dn=ht,Bn=function(){var e=tt();return function(t,r,i,n,o,s){var a,c;for(r||(r=4),i||(i=0),n?c=Math.min(n*r+i,t.length):c=t.length,a=i;a<c;a+=r)e[0]=t[a],e[1]=t[a+1],e[2]=t[a+2],e[3]=t[a+3],o(e,e,s),t[a]=e[0],t[a+1]=e[1],t[a+2]=e[2],t[a+3]=e[3];return t}}()});var g={};Z(g,{add:()=>On,angle:()=>no,ceil:()=>kn,clone:()=>Cn,copy:()=>Nn,create:()=>lt,cross:()=>Kn,dist:()=>po,distance:()=>mt,div:()=>mo,divide:()=>dt,dot:()=>$n,equals:()=>co,exactEquals:()=>ho,floor:()=>Gn,forEach:()=>_o,fromValues:()=>Fn,inverse:()=>Wn,len:()=>lo,length:()=>vt,lerp:()=>jn,max:()=>Vn,min:()=>zn,mul:()=>uo,multiply:()=>ut,negate:()=>Xn,normalize:()=>Zn,random:()=>Jn,rotate:()=>io,round:()=>Yn,scale:()=>Hn,scaleAndAdd:()=>qn,set:()=>Un,signedAngle:()=>oo,sqrDist:()=>vo,sqrLen:()=>go,squaredDistance:()=>pt,squaredLength:()=>gt,str:()=>ao,sub:()=>fo,subtract:()=>ft,transformMat2:()=>Qn,transformMat2d:()=>eo,transformMat3:()=>to,transformMat4:()=>ro,zero:()=>so});function lt(){var e=new L(2);return L!=Float32Array&&(e[0]=0,e[1]=0),e}function Cn(e){var t=new L(2);return t[0]=e[0],t[1]=e[1],t}function Fn(e,t){var r=new L(2);return r[0]=e,r[1]=t,r}function Nn(e,t){return e[0]=t[0],e[1]=t[1],e}function Un(e,t,r){return e[0]=t,e[1]=r,e}function On(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e}function ft(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e}function ut(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e}function dt(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e}function kn(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function Gn(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function zn(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e}function Vn(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e}function Yn(e,t){return e[0]=U(t[0]),e[1]=U(t[1]),e}function Hn(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e}function qn(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e}function mt(e,t){var r=t[0]-e[0],i=t[1]-e[1];return Math.sqrt(r*r+i*i)}function pt(e,t){var r=t[0]-e[0],i=t[1]-e[1];return r*r+i*i}function vt(e){var t=e[0],r=e[1];return Math.sqrt(t*t+r*r)}function gt(e){var t=e[0],r=e[1];return t*t+r*r}function Xn(e,t){return e[0]=-t[0],e[1]=-t[1],e}function Wn(e,t){return e[0]=1/t[0],e[1]=1/t[1],e}function Zn(e,t){var r=t[0],i=t[1],n=r*r+i*i;return n>0&&(n=1/Math.sqrt(n)),e[0]=t[0]*n,e[1]=t[1]*n,e}function $n(e,t){return e[0]*t[0]+e[1]*t[1]}function Kn(e,t,r){var i=t[0]*r[1]-t[1]*r[0];return e[0]=e[1]=0,e[2]=i,e}function jn(e,t,r,i){var n=t[0],o=t[1];return e[0]=n+i*(r[0]-n),e[1]=o+i*(r[1]-o),e}function Jn(e,t){t=t===void 0?1:t;var r=z()*2*Math.PI;return e[0]=Math.cos(r)*t,e[1]=Math.sin(r)*t,e}function Qn(e,t,r){var i=t[0],n=t[1];return e[0]=r[0]*i+r[2]*n,e[1]=r[1]*i+r[3]*n,e}function eo(e,t,r){var i=t[0],n=t[1];return e[0]=r[0]*i+r[2]*n+r[4],e[1]=r[1]*i+r[3]*n+r[5],e}function to(e,t,r){var i=t[0],n=t[1];return e[0]=r[0]*i+r[3]*n+r[6],e[1]=r[1]*i+r[4]*n+r[7],e}function ro(e,t,r){var i=t[0],n=t[1];return e[0]=r[0]*i+r[4]*n+r[12],e[1]=r[1]*i+r[5]*n+r[13],e}function io(e,t,r,i){var n=t[0]-r[0],o=t[1]-r[1],s=Math.sin(i),a=Math.cos(i);return e[0]=n*a-o*s+r[0],e[1]=n*s+o*a+r[1],e}function no(e,t){var r=e[0],i=e[1],n=t[0],o=t[1];return Math.abs(Math.atan2(i*n-r*o,r*n+i*o))}function oo(e,t){var r=e[0],i=e[1],n=t[0],o=t[1];return Math.atan2(r*o-i*n,r*n+i*o)}function so(e){return e[0]=0,e[1]=0,e}function ao(e){return"vec2("+e[0]+", "+e[1]+")"}function ho(e,t){return e[0]===t[0]&&e[1]===t[1]}function co(e,t){var r=e[0],i=e[1],n=t[0],o=t[1];return Math.abs(r-n)<=R*Math.max(1,Math.abs(r),Math.abs(n))&&Math.abs(i-o)<=R*Math.max(1,Math.abs(i),Math.abs(o))}var lo,fo,uo,mo,po,vo,go,_o,_t=_(()=>{se();lo=vt,fo=ft,uo=ut,mo=dt,po=mt,vo=pt,go=gt,_o=function(){var e=lt();return function(t,r,i,n,o,s){var a,c;for(r||(r=2),i||(i=0),n?c=Math.min(n*r+i,t.length):c=t.length,a=i;a<c;a+=r)e[0]=t[a],e[1]=t[a+1],o(e,e,s),t[a]=e[0],t[a+1]=e[1];return t}}()});var $=_(()=>{qe();_t();et();ct()});var pe,Ne=_(()=>{"use strict";pe=class{#e;#t;#i;constructor(){this.#e=[],this.#t=[],this.#i=null,this.#n()}#n(){this.#i=null,this.#i?.addEventListener("message",t=>{for(let r of this.#e)r(JSON.parse(t.data))}),this.#i?.addEventListener("open",()=>{console.log(`Connected to editor server, sending ${this.#t.length} queued requests...`);for(let t of this.#t)this.send(t);this.#t=[]}),this.#i?.addEventListener("close",()=>{console.error("Editor server disconnected");for(let t of this.#e)t({type:"EDITOR_DISCONNECTED"});setTimeout(()=>{console.warn("Attempting to reconnect to editor server..."),this.#i=null,this.#n()},1e3)})}send(t){this.#i?.readyState===WebSocket.OPEN?this.#i?.send(JSON.stringify(t)):(console.warn(`Editor server not connected, queueing request ${t.type}`),this.#t.push(t))}listen(t){this.#e.push(t)}disconnect(t){for(let r=this.#e.length-1;r>=0;--r)t===this.#e[r]&&this.#e.splice(r,1)}}});var ae,X,C,Ue=_(()=>{"use strict";$();ae=x.create();x.translate(ae,ae,[-1,-1]);x.scale(ae,ae,[2,2]);X=ae,C=class{#e;#t;#i;#n;#r;constructor(t){this.#t=t,this.#r="",this.#n=null,this.#i=this.#t.createVertexArray();let r=new Float32Array([0,0,1,0,0,1,1,1]);this.#e=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.#e),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null)}#o(t,r){let i={position:t.inAttributes[r.position].location};return{...i,hash:`${i.position}`}}bind(t,r,i){let n=this.#o(t,r);this.#t.bindVertexArray(this.#i),(this.#r!==n.hash||this.#n!==null)&&(this.#t.bindBuffer(this.#t.ARRAY_BUFFER,this.#e),this.#t.enableVertexAttribArray(n.position),this.#t.vertexAttribPointer(n.position,2,this.#t.FLOAT,!1,0,0),this.#r=n.hash,this.#n=null),i(this),this.#t.bindVertexArray(null)}draw(){this.#t.drawArrays(this.#t.TRIANGLE_STRIP,0,4)}bindInstances(t,r,i,n){let o=this.#o(t,r),s=i.getAttributesHash(t),a=`${o.hash}:${s}`;this.#t.bindVertexArray(this.#i),(this.#r!==a||this.#n!==i)&&(this.#t.bindBuffer(this.#t.ARRAY_BUFFER,this.#e),this.#t.enableVertexAttribArray(o.position),this.#t.vertexAttribPointer(o.position,2,this.#t.FLOAT,!1,0,0),this.#r=a,this.#n=i.bind(t));let c=i.getInstanceCount();n({draw:()=>{this.#t.drawArraysInstanced(this.#t.TRIANGLE_STRIP,0,4,c)}}),this.#t.bindVertexArray(null)}}});function xt(){return null}function bt(e,t){let r=xt();if(r){let i=e.indexOf("?v="),n=e.substring(0,i),o=r.get(n);o?o.push(t):r.set(n,[t])}}function Et(e){let t=xt();if(t){let r=Object.values(e.urls);for(let i of r){let n=i.indexOf("?v="),o=i.substring(0,n),s=t.get(o);if(s)for(let a of s)a(i)}}}async function K(e,t,r){let i=await ve(t),n={[y]:ge(e,i,r),width:i.width,height:i.height};return bt(t,o=>{ve(o).then(s=>{n[y]=ge(e,s,r),n.width=s.width,n.height=s.height})}),n}async function wt(e,t,r){let i=await ve(t),n={image:i,[y]:ge(e,i,r),width:i.width,height:i.height};return bt(t,o=>{ve(o).then(s=>{n.image=s,n[y]=ge(e,s,r),n.width=s.width,n.height=s.height})}),n}function ve(e){return new Promise((t,r)=>{let i=new Image;i.onload=()=>t(i),i.onerror=n=>r(n),i.src=e})}function ge(e,t,r){let i=e.gl.createTexture();return e.gl.activeTexture(e.gl.TEXTURE0),e.gl.bindTexture(e.gl.TEXTURE_2D,i),e.gl.pixelStorei(e.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.gl.pixelStorei(e.gl.UNPACK_FLIP_Y_WEBGL,!0),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_WRAP_S,r?.wrap||e.gl.CLAMP_TO_EDGE),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_WRAP_T,r?.wrap||e.gl.CLAMP_TO_EDGE),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_MIN_FILTER,r?.filter||(r?.mipmap?e.gl.LINEAR_MIPMAP_LINEAR:e.gl.LINEAR)),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_MAG_FILTER,r?.filter||(r?.mipmap?e.gl.LINEAR_MIPMAP_LINEAR:e.gl.LINEAR)),e.gl.texImage2D(e.gl.TEXTURE_2D,0,e.gl.RGBA,e.gl.RGBA,e.gl.UNSIGNED_BYTE,t),r?.mipmap&&e.gl.generateMipmap(e.gl.TEXTURE_2D),e.gl.bindTexture(e.gl.TEXTURE_2D,null),i}var y,J=_(()=>{"use strict";y=Symbol()});function _e(){return null}function xo(e,t,r){let i=_e()?.programs;if(i){let n=i.get(e.name);n?n.push(r):i.set(e.name,[r]);let o=i.get(t.name);o?o.push(r):i.set(t.name,[r])}}function Tt(e,t){let r=_e();if(r){console.log("reloading shader",e),r.cache.set(e,t);let i=r.programs.get(e);if(i)for(let n of i)n()}}function xe(e,t,r,i,n,o,s){let a=e.createTexture();return e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,a),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,s?.wrap||e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,s?.wrap||e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,s?.filter||e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,s?.filter||e.LINEAR),e.texImage2D(e.TEXTURE_2D,0,t,n,o,0,r,i,null),e.bindTexture(e.TEXTURE_2D,null),a}var B,q,Q,O,be=_(()=>{"use strict";J();B=class{#e;#t;#i;#n;inAttributes;outAttributes;uniforms;constructor(t,r,i){this.#e=t,this.#i=r,this.#n=i,this.inAttributes={},this.outAttributes={},this.uniforms={},this.#t=this.#r(this.#i,this.#n),this.setAttributesAndUniforms(this.#i,this.#n),xo(r,i,()=>{try{this.#t=this.#r(this.#i,this.#n)}catch(n){console.error(n);return}this.setAttributesAndUniforms(this.#i,this.#n)})}setAttributesAndUniforms(t,r){let i=this.#e.getProgramParameter(this.#t,this.#e.ACTIVE_ATTRIBUTES);for(let o=0;o<i;++o){let s=this.#e.getActiveAttrib(this.#t,o);if(s){let a=s.name;a in t.inAttributes&&(this.inAttributes[a]={location:this.#e.getAttribLocation(this.#t,s.name),type:t.inAttributes[a].type})}}Object.keys(r.outAttributes).forEach(o=>{let s=this.#e.getFragDataLocation(this.#t,o);this.outAttributes[o]={location:s,type:r.outAttributes[o].type}});let n=this.#e.getProgramParameter(this.#t,this.#e.ACTIVE_UNIFORMS);for(let o=0;o<n;++o){let s=this.#e.getActiveUniform(this.#t,o);if(s){let a=s.name;(a in t.uniforms||a in r.uniforms)&&(this.uniforms[s.name]={location:this.#e.getUniformLocation(this.#t,s.name),type:t.uniforms[a]||r.uniforms[a]})}}}#r(t,r){let i=this.#e.createProgram(),n=this.#e.createShader(this.#e.VERTEX_SHADER),o=_e()?.cache?.get(t.name)||t.src;this.#e.shaderSource(n,o),this.#e.compileShader(n);let s="";if(!this.#e.getShaderParameter(n,this.#e.COMPILE_STATUS)){let h=this.#e.getShaderInfoLog(n);h&&(s+=h+`
`)}let a=this.#e.createShader(this.#e.FRAGMENT_SHADER),c=_e()?.cache?.get(r.name)||r.src;if(this.#e.shaderSource(a,c),this.#e.compileShader(a),!this.#e.getShaderParameter(a,this.#e.COMPILE_STATUS)){let h=this.#e.getShaderInfoLog(a);h&&(s+=h+`
`)}if(this.#e.attachShader(i,n),this.#e.attachShader(i,a),s===""&&(this.#e.linkProgram(i),!this.#e.getProgramParameter(i,this.#e.LINK_STATUS))){let h=this.#e.getProgramInfoLog(i);h&&(s+=`
Linker: (${t.name}, ${r.name}): ${h}`)}if(s!=="")throw new Error(`Shader compilation of [${t.name}, ${r.name}] failed:
${s}`);return i}use(t){this.#e.useProgram(this.#t),t(this),this.#e.useProgram(null)}setUniforms(t){let r=0;for(let i in t){let n=t[i],o=this.uniforms[i];if(o)o.type==="sampler2D"?(this.#e.activeTexture(this.#e[`TEXTURE${r}`]),this.#e.bindTexture(this.#e.TEXTURE_2D,n&&y in n?n[y]:n),this.#e.uniform1i(o.location,r++)):o.type==="float"?this.#e.uniform1f(o.location,n):o.type==="vec2"?this.#e.uniform2fv(o.location,n):o.type==="vec3"?this.#e.uniform3fv(o.location,n):o.type==="vec4"?this.#e.uniform4fv(o.location,n):o.type==="mat2"?this.#e.uniformMatrix2fv(o.location,!1,n):o.type==="mat3"?this.#e.uniformMatrix3fv(o.location,!1,n):o.type==="mat4"?this.#e.uniformMatrix4fv(o.location,!1,n):o.type==="int"&&this.#e.uniform1i(o.location,n);else continue}return this}},q=class{#e;#t;#i;#n;#r=[];constructor(t,r,i){this.#t=t,this.#e=this.#t.createBuffer(),this.#n=0,this.#i=0,this.#r=[];for(let[n,o]of Object.entries(i)){let s=r.inAttributes[n].type;if(s==="float")this.#r.push({col:1,row:1,size:1,name:n,load:(a,c,h)=>{a[c]=o(h)}});else{let a={name:n,load:(c,h,l)=>c.set(o(l),h)};switch(s){case"vec2":this.#r.push({col:1,row:2,size:2,...a});break;case"vec3":this.#r.push({col:1,row:3,size:3,...a});break;case"vec4":this.#r.push({col:1,row:4,size:4,...a});break;case"mat2":this.#r.push({col:2,row:2,size:4,...a});break;case"mat3":this.#r.push({col:3,row:3,size:9,...a});break;case"mat4":this.#r.push({col:4,row:4,size:16,...a});break;default:throw new Error("Unknown instance buffer attribute type")}}this.#i+=this.#r[this.#r.length-1].size}}load(t){this.#n=t.length;let r=new Float32Array(t.length*this.#i),i=0;for(let n=0;n<t.length;++n)for(let o=0;o<this.#r.length;++o)this.#r[o].load(r,i,t[n]),i+=this.#r[o].size;return this.#t.bindBuffer(this.#t.ARRAY_BUFFER,this.#e),this.#t.bufferData(this.#t.ARRAY_BUFFER,r,this.#t.STREAM_DRAW),this.#t.bindBuffer(this.#t.ARRAY_BUFFER,null),this}getInstanceCount(){return this.#n}getAttributesHash(t){return this.#r.map(r=>t.inAttributes[r.name].location).join("-")}bind(t){this.#t.bindBuffer(this.#t.ARRAY_BUFFER,this.#e);let r=0;for(let i=0;i<this.#r.length;++i){let n=t.inAttributes[this.#r[i].name].location;for(let o=0;o<this.#r[i].col;++o)this.#t.enableVertexAttribArray(n+o),this.#t.vertexAttribPointer(n+o,this.#r[i].row,this.#t.FLOAT,!1,this.#i*4,r),this.#t.vertexAttribDivisor(n+o,1),r+=this.#r[i].row*4}return this}},Q=class{#e;textures;width;height;#t;constructor(t,r){this.#t=t,this.#e=r,this.textures=null,this.width=0,this.height=0}use(t,r){return(!this.textures||t.width!==this.width||t.height!==this.height)&&(this.textures=Object.keys(this.#e).reduce((i,n)=>{let o=this.#e[n];return i[n]={[y]:xe(this.#t,o.internalFormat,o.format,o.type,t.width,t.height,o.opts),width:t.width,height:t.height},i},{}),this.height=t.height,this.width=t.width,r(this.textures)),this.textures}},O=class e{#e;#t;static#i=[];constructor(t,r,i){this.#e=t,this.#t=this.#e.createFramebuffer(),this.#e.bindFramebuffer(this.#e.FRAMEBUFFER,this.#t);let n=[];Object.entries(i).forEach(([o,s])=>{let a=r.outAttributes[o].location;this.#e.framebufferTexture2D(this.#e.FRAMEBUFFER,this.#e[`COLOR_ATTACHMENT${a}`],this.#e.TEXTURE_2D,s&&y in s?s[y]:s,0),n.push(this.#e[`COLOR_ATTACHMENT${a}`])}),this.#e.drawBuffers(n.sort((o,s)=>o-s)),this.#e.bindFramebuffer(this.#e.FRAMEBUFFER,null)}bind(t){e.#i.push(this.#t),this.#e.bindFramebuffer(this.#e.FRAMEBUFFER,this.#t),t(),e.#i.pop(),e.#i.length?this.#e.bindFramebuffer(this.#e.FRAMEBUFFER,e.#i[e.#i.length-1]):this.#e.bindFramebuffer(this.#e.FRAMEBUFFER,null)}}});function St(){return null}function Eo(e,t){let r=St();if(r){let i=r.get(e.name);i?i.reloaders.push(t):r.set(e.name,{config:e,reloaders:[t]})}}function yt(e){let t=St();if(t){let r=t.get(e.name);if(r){Object.keys(r.config).forEach(i=>delete r.config[i]),Object.assign(r.config,e);for(let i of r.reloaders)i(e)}}}async function le(e,t,r){let i=await r(e,t);return wo(e,t,i)}function wo(e,t,r){let i=Mt(t,r);return Eo(t,n=>{Object.keys(i).forEach(o=>delete i[o]),Object.assign(i,Mt(n,r))}),{...i,[y]:r}}function Mt(e,t){return Object.keys(e.sprites).reduce((r,i)=>{let n=e.sprites[i],o=n.frames.map(s=>w.fromValues(s.top,s.right,s.bottom,s.left));return r[i]={index:n.index,width:n.width,height:n.height,frames:o,draw:(s,a,c=0)=>(s.setTextures(t),s.draw(a,o[Math.floor(c)%o.length]),r[i])},r},{})}var ee,te,he,bo,Ee,ce,we=_(()=>{"use strict";$();J();ee=P.set(P.create(),0,1,0),te=P.set(P.create(),0,0,1),he=P.cross(P.create(),ee,te),bo=x.set(x.create(),ee[0],he[0],te[0],ee[1],he[1],te[1],ee[2],he[2],te[2]),Ee=x.transpose(x.create(),bo);ce=class{#e;#t;#i;frameRate;frame;constructor(t,r,i){this.frameRate=i,this.frame=0,this.#e=t,this.#i=r,this.#t=t[r]}tick(t){this.frame+=t*this.frameRate,this.frame>this.#t.frames.length&&(this.frame-=this.#t.frames.length)}getSprite(){return this.#t}getSpriteName(){return this.#i}setSprite(t){let r=this.#e[t];r!==this.#t&&(this.#t=r,this.#i=t,this.frame=0)}setSpriteOrTick(t,r){let i=this.#e[t];i!==this.#t?(this.#t=i,this.#i=t,this.frame=0):this.tick(r)}draw(t,r,i=0){this.#t.draw(t,r,this.frame+i)}}});var At=_(()=>{"use strict"});var E={};Z(E,{TILE_SIZE:()=>D,pickAbsoluteTileFromRelative:()=>Pt,toAbsoluteFromRelative:()=>It,toAbsoluteTileFromAbsolute:()=>fe,toRelativeFromAbsolute:()=>Rt,toRelativeFromRelativeTile:()=>Dt,toRelativeTileFromAbsolute:()=>yo,toRelativeTileFromAbsoluteTile:()=>Lt,toRelativeTileFromRelative:()=>Ao,toScreenSpaceFromAbsoluteTile:()=>So});function It(e,t,r){return g.add(e,t,r.absolutePosition)}function Rt(e,t,r){return g.subtract(e,t,r.absolutePosition)}function fe(e,t){return w.set(e,Math.floor(t[0]/D),Math.floor(t[1]/D),Math.floor(t[0])%D,Math.floor(t[1])%D)}function Pt(e,t,r){let i=g.create();return It(i,t,r),w.set(e,Math.floor(i[0]/D),Math.floor(i[1]/D),Math.floor(i[0])%D,Math.floor(i[1])%D)}function So(e,t,r){return Lt(e,t,r),r.toScreenSpace(e,Dt(e,e))}function yo(e,t,r){let i=g.create();return Rt(i,t,r),w.set(e,Math.floor(i[0]/D),Math.floor(i[1]/D),Math.floor(i[0])%D,Math.floor(i[1])%D)}function Lt(e,t,r){let i=fe(w.create(),r.absolutePosition);return w.set(e,t[0]-i[0],t[1]-i[1],i[2],i[3])}function Ao(e,t,r){let i=fe(w.create(),r.absolutePosition);return Pt(e,t,r),w.set(e,e[0]-i[0],e[1]-i[1],i[2],i[3])}function Dt(e,t,r=1){return w.set(e,t[1]*D-t[3],t[0]*D+D*r-t[2],t[1]*D+D*r-t[3],t[0]*D-t[2])}var D,Ge=_(()=>{"use strict";$();D=16});function Bt(e,t){return{index:e[t],triggerId:e[t+1],walkable:(e[t+2]&1)===1,spatialHash:(e[t+2]&2)===2,animated:(e[t+2]&4)===4}}function Ct(e,t,r){e[t]=r.index,e[t+1]=r.triggerId,e[t+2]=(r.walkable?1:0)|(r.spatialHash?2:0)|(r.animated?4:0)}async function Ft(e,t,r,i){let[n,o]=await Promise.all([le(e,r.spriteSheet,i),wt(e,r.url)]);return{data:new ze(e,t,o),name:r.name,sprite:n,spriteConfig:r.spriteSheet}}var ze,Nt=_(()=>{"use strict";$();Ge();J();we();ze=class{buffer;width;height;tileSize;bufferPosition;lastScreenPosition;lastScreenWidth;lastScreenHeight;offscreen;constructor(t,r,i){this.offscreen=new OffscreenCanvas(i.width,i.height).getContext("2d",{willReadFrequently:!0}),this.offscreen.drawImage(i.image,0,0,i.width,i.height),this.width=i.width,this.height=i.height,this.tileSize=r,this.buffer=new ImageData(t.screen.width/r+3,t.screen.height/r+3),this.bufferPosition=w.create(),this.lastScreenPosition=g.create(),this.lastScreenWidth=0,this.lastScreenHeight=0}updateScreenBuffer(t,r){if(this.lastScreenWidth!==t.screen.width||this.lastScreenHeight!==t.screen.height||this.lastScreenPosition[0]!==r[0]||this.lastScreenPosition[1]!==r[1]){let i=fe(w.create(),r);this.bufferPosition=w.fromValues(i[0]-1,i[1]-1,t.screen.width/this.tileSize+3,t.screen.height/this.tileSize+3),this.buffer=this.offscreen.getImageData(this.bufferPosition[0],this.bufferPosition[1],this.bufferPosition[2],this.bufferPosition[3]),this.lastScreenPosition=g.clone(r),this.lastScreenWidth=t.screen.width,this.lastScreenHeight=t.screen.height}}read(t,r){if(t>=this.bufferPosition[0]&&t<this.bufferPosition[0]+this.bufferPosition[2]&&r>=this.bufferPosition[1]&&r<this.bufferPosition[1]+this.bufferPosition[3]){t-=this.bufferPosition[0],r-=this.bufferPosition[1];let i=4*(this.buffer.width*r+t);return Bt(this.buffer.data,i)}else{let i=this.offscreen.getImageData(t,r,1,1);return Bt(i.data,0)}}write(t,r,i){if(t>=this.bufferPosition[0]&&t<this.bufferPosition[0]+this.bufferPosition[2]&&r>=this.bufferPosition[1]&&r<this.bufferPosition[1]+this.bufferPosition[3]){t-=this.bufferPosition[0],r-=this.bufferPosition[1];let n=4*(this.buffer.width*r+t);Ct(this.buffer.data,n,i),this.offscreen.putImageData(this.buffer,this.bufferPosition[0],this.bufferPosition[1])}else{let n=new ImageData(1,1);Ct(n.data,0,i),this.offscreen.putImageData(n,t,r)}}}});var re={};Z(re,{hash:()=>Ro,smoothstep:()=>Io});function Io(e,t,r){return r=Math.max(0,Math.min(1,(r-e)/(t-e))),r*r*(3-2*r)}function Ro(e,t){let n=44488.07041494893,o=2147483647%48271,s=48271*(e%n)-o*Math.floor(e/n);return s>=0?e=s:e=s+2147483647,s=48271*(t%n)-o*Math.floor(t/n),s>=0?t=s:t=s+2147483647,e^t}var Ut=_(()=>{"use strict"});var Te,Ot=_(()=>{"use strict";Te=class{#e;#t;ready;constructor(t){this.#e={},this.ready=!1;let r=Object.keys(t);this.#t=Promise.all(r.map(i=>t[i])).then(i=>(r.reduce((n,o,s)=>(n[o]=i[s],n),this.#e),this.ready=!0,this.#e))}ifReady(t){return this.ready&&t(this.#e),this.ready}whenReady(){return this.#t}}});var W=_(()=>{"use strict";At();Ne();Nt();we();Ue();be();J();Ge();Ut();Ot()});var ie=_(()=>{"use strict";$()});var ue,Po,kt,Gt=_(()=>{"use strict";(function(e){e[e.LIGHTING_MODE_DIRECTIONAL=0]="LIGHTING_MODE_DIRECTIONAL",e[e.LIGHTING_MODE_POINT=1]="LIGHTING_MODE_POINT"})(ue||(ue={}));Po={src:`#version 300 es
precision mediump float;in vec2 v_texCoord;in vec3 v_ambient;in vec3 v_diffuse;in vec3 v_direction;in float v_radius;uniform vec3 u_viewDirection;uniform int u_lightingMode;uniform sampler2D u_albedoTexture;uniform sampler2D u_normalTexture;uniform sampler2D u_specularTexture;uniform mat3 u_toTangentSpace;const int A=0;const int B=1;const float C=2.;const float D=32.;layout(location=0)out vec4 o_lighting;void main(){vec3 E=normalize(texture(u_normalTexture,v_texCoord).rgb*2.-1.);vec3 F=texture(u_albedoTexture,v_texCoord).rgb;vec3 G=texture(u_specularTexture,v_texCoord).rgb;vec3 H=v_ambient*F;vec3 I=u_lightingMode==A?v_direction:vec3(v_texCoord,0.)-v_direction;I.y*=u_lightingMode==A?1.:-1.;float J=u_lightingMode==A?1.:pow(1.-min(v_radius,length(I))/v_radius,C);vec3 K=normalize(I*-1.)*u_toTangentSpace;float L=max(dot(E,K),0.);vec3 M=F*v_diffuse*L*J;vec3 N=normalize(K+(u_viewDirection*-1.*u_toTangentSpace));float O=max(dot(E,N),0.);float P=pow(O,D);vec3 Q=v_diffuse*P*G*J;o_lighting=vec4(H+M+Q,1.);}`,name:"deferred-lighting.frag",inAttributes:{},outAttributes:{o_lighting:{type:"vec4",location:0}},uniforms:{u_viewDirection:"vec3",u_lightingMode:"int",u_albedoTexture:"sampler2D",u_normalTexture:"sampler2D",u_specularTexture:"sampler2D",u_toTangentSpace:"mat3"}},kt=Po});var zt,Lo,Vt,Yt=_(()=>{"use strict";zt||(zt={});Lo={src:`#version 300 es
in vec2 a_position;in mat3 a_mvp;in mat3 a_uv;in vec3 a_ambient;in vec3 a_diffuse;in vec3 a_direction;in float a_radius;out vec3 v_ambient;out vec3 v_diffuse;out vec3 v_direction;out float v_radius;out vec2 v_texCoord;void main(){vec3 A=a_uv*vec3(a_position,1.);v_texCoord=A.xy;v_ambient=a_ambient;v_diffuse=a_diffuse;v_direction=a_direction;v_radius=a_radius;vec3 B=a_mvp*vec3(a_position,1.);gl_Position=vec4(B.xy,0.,1.);}`,name:"deferred-lighting.vert",inAttributes:{a_position:{type:"vec2"},a_mvp:{type:"mat3"},a_uv:{type:"mat3"},a_ambient:{type:"vec3"},a_diffuse:{type:"vec3"},a_direction:{type:"vec3"},a_radius:{type:"float"}},outAttributes:{},uniforms:{}},Vt=Lo});var Ht,Do,qt,Xt=_(()=>{"use strict";Ht||(Ht={});Do={src:`#version 300 es
precision mediump float;in vec2 v_texCoord;uniform sampler2D u_diffuseTexture;uniform sampler2D u_normalTexture;uniform sampler2D u_specularTexture;uniform sampler2D u_emissiveTexture;layout(location=0)out vec4 o_normal;layout(location=1)out vec4 o_albedo;layout(location=2)out vec4 o_specular;layout(location=3)out vec4 o_lighting;layout(location=4)out vec4 o_mask;void main(){vec4 A=texture(u_diffuseTexture,v_texCoord);vec3 B=texture(u_normalTexture,v_texCoord).xyz;float C=texture(u_specularTexture,v_texCoord).x;vec3 D=texture(u_emissiveTexture,v_texCoord).xyz;float E=A.w<0.99?0.:1.;o_albedo=vec4(A.xyz*E,E);o_mask=o_albedo;o_normal=vec4(B,E);o_specular=vec4(C,C,C,E);o_lighting=vec4(D,E);}`,name:"deferred-sprite.frag",inAttributes:{},outAttributes:{o_normal:{type:"vec4",location:0},o_albedo:{type:"vec4",location:1},o_specular:{type:"vec4",location:2},o_lighting:{type:"vec4",location:3},o_mask:{type:"vec4",location:4}},uniforms:{u_diffuseTexture:"sampler2D",u_normalTexture:"sampler2D",u_specularTexture:"sampler2D",u_emissiveTexture:"sampler2D"}},qt=Do});var Wt,Bo,Zt,$t=_(()=>{"use strict";Wt||(Wt={});Bo={src:`#version 300 es
in vec2 a_position;in mat3 a_uv;in mat3 a_mvp;out vec2 v_texCoord;void main(){vec3 A=a_uv*vec3(a_position,1.);vec3 B=a_mvp*vec3(a_position,1.);v_texCoord=A.xy;gl_Position=vec4(B.xy,0.,1.);}`,name:"deferred-sprite.vert",inAttributes:{a_position:{type:"vec2"},a_uv:{type:"mat3"},a_mvp:{type:"mat3"}},outAttributes:{},uniforms:{}},Zt=Bo});async function Ve(e,t){let[r,i,n,o]=await Promise.all([K(e,t.urls.diffuse),K(e,t.urls.normal),K(e,t.urls.specular),K(e,t.urls.emissive)]);return{diffuseTexture:r,normalTexture:i,specularTexture:n,emissiveTexture:o}}var Me,Co,Fo,Se,Kt=_(()=>{"use strict";W();ie();Gt();Yt();Xt();$t();Me=class extends ce{},Co=P.fromValues(0,0,0),Fo=x.create();Se=class{#e;#t;#i;#n;#r;#o;#s;#h;#a;#l;#c;#f;constructor(t){this.#e=t.gl,this.#t=new B(t.gl,Zt,qt),this.#i=new q(this.#e,this.#t,{a_mvp:r=>r.mvp,a_uv:r=>r.uv}),this.#n=[],this.#r=new B(t.gl,Vt,kt),this.#o=new q(this.#e,this.#r,{a_mvp:r=>r.mvp,a_uv:r=>r.uv,a_ambient:r=>r.ambient,a_diffuse:r=>r.diffuse,a_direction:r=>r.direction,a_radius:r=>r.radius}),this.#s=[],this.#h=[],this.#l=new C(this.#e),this.#a=null,this.#f=null,this.#c=new Q(this.#e,{normal:{internalFormat:this.#e.RGBA,format:this.#e.RGBA,type:this.#e.UNSIGNED_BYTE},albedo:{internalFormat:this.#e.RGBA,format:this.#e.RGBA,type:this.#e.UNSIGNED_BYTE},specular:{internalFormat:this.#e.RGBA,format:this.#e.RGBA,type:this.#e.UNSIGNED_BYTE},lighting:{internalFormat:this.#e.RGBA,format:this.#e.RGBA,type:this.#e.UNSIGNED_BYTE},mask:{internalFormat:this.#e.RGBA,format:this.#e.RGBA,type:this.#e.UNSIGNED_BYTE}})}use(t,r,i){let n=this.#c.use(t,a=>{this.#f={maskFrameBuffer:new O(this.#e,this.#t,{o_normal:a.normal,o_albedo:a.albedo,o_specular:a.specular,o_lighting:a.lighting,o_mask:i?a.mask:null}),noMaskFrameBuffer:new O(this.#e,this.#t,{o_normal:a.normal,o_albedo:a.albedo,o_specular:a.specular,o_lighting:a.lighting,o_mask:null}),lightingFrameBuffer:new O(this.#e,this.#r,{o_lighting:a.lighting})}}),o=this.#f,s=this.#e.getParameter(this.#e.VIEWPORT);this.#e.viewport(0,0,this.#c.width,this.#c.height),o.maskFrameBuffer.bind(()=>{this.#e.clear(this.#e.COLOR_BUFFER_BIT|this.#e.DEPTH_BUFFER_BIT),this.#t.use(()=>{r(this,0),this.#u()})}),i&&o.noMaskFrameBuffer.bind(()=>{i(n.mask),this.#t.use(()=>{r(this,1),this.#u()})}),o.lightingFrameBuffer.bind(()=>{let a=this.#e.getParameter(this.#e.BLEND),c=this.#e.getParameter(this.#e.BLEND_SRC_ALPHA),h=this.#e.getParameter(this.#e.BLEND_DST_ALPHA);this.#e.enable(this.#e.BLEND),this.#e.blendFunc(this.#e.ONE,this.#e.ONE),this.#r.use(l=>{l.setUniforms({u_albedoTexture:n.albedo,u_normalTexture:n.normal,u_specularTexture:n.specular,u_toTangentSpace:Ee,u_viewDirection:P.fromValues(0,0,-1)}),this.#s.length&&(l.setUniforms({u_lightingMode:ue.LIGHTING_MODE_DIRECTIONAL}),this.#l.bindInstances(l,{position:"a_position"},this.#o.load(this.#s),u=>u.draw()),this.#s.length=0),this.#h.length&&(l.setUniforms({u_lightingMode:ue.LIGHTING_MODE_POINT}),this.#l.bindInstances(l,{position:"a_position"},this.#o.load(this.#h),u=>u.draw()),this.#h.length=0)}),a||this.#e.disable(this.#e.BLEND),this.#e.blendFunc(c,h)}),this.#e.viewport(s[0],s[1],s[2],s[3])}addDirectionalLight(t){return this.#s.push({mvp:X,uv:Fo,ambient:t.ambient,diffuse:t.diffuse,direction:t.direction,radius:0}),this}addPointLight(t){if(t.position[2]>=t.radius)return this;let r=Math.sqrt(t.radius*t.radius-t.position[2]*t.position[2]),i=x.create();x.translate(i,i,[t.position[0]-r,t.position[1]-r]),x.scale(i,i,[r*2,r*2]),x.mul(i,X,i);let n=x.create();return x.translate(n,n,[t.position[0]-r,t.position[1]-r]),x.scale(n,n,[r*2,r*2]),this.#h.push({mvp:i,uv:n,ambient:Co,diffuse:t.diffuse,direction:P.fromValues(t.position[0],t.position[1],t.position[2]),radius:t.radius}),this}getLightingTexture(){return this.#c.textures?.lighting}setTextures(t){return t===this.#a?this:(this.#n.length&&this.#u(),this.#a=t,this.#t.setUniforms({u_diffuseTexture:t.diffuseTexture[y],u_normalTexture:t.normalTexture[y],u_specularTexture:t.specularTexture[y],u_emissiveTexture:t.emissiveTexture[y]}),this)}draw(t,r){if(this.#a){let i=x.create();x.translate(i,i,[t[3],t[0]]),x.scale(i,i,[t[1]-t[3],t[2]-t[0]]),x.multiply(i,X,i);let n=x.create();x.translate(n,n,[r[3]/this.#a.diffuseTexture.width,r[0]/this.#a.diffuseTexture.height]),x.scale(n,n,[(r[1]-r[3])/this.#a.diffuseTexture.width,(r[2]-r[0])/this.#a.diffuseTexture.height]),this.#n.push({mvp:i,uv:n})}return this}#u(){this.#n.length&&(this.#l.bindInstances(this.#t,{position:"a_position"},this.#i.load(this.#n),t=>t.draw()),this.#n.length=0,this.#a=null)}}});var jt,No,Jt,Qt=_(()=>{"use strict";jt||(jt={});No={src:`#version 300 es
precision mediump float;in vec2 v_texCoord;in float v_alpha;uniform sampler2D u_texture;out vec4 outColor;void main(){outColor=texture(u_texture,v_texCoord);outColor.a*=v_alpha;}`,name:"sprite.frag",inAttributes:{},outAttributes:{outColor:{type:"vec4"}},uniforms:{u_texture:"sampler2D"}},Jt=No});var er,Uo,tr,rr=_(()=>{"use strict";er||(er={});Uo={src:`#version 300 es
in vec2 a_position;in mat3 a_uv;in mat3 a_mvp;in float a_alpha;out vec2 v_texCoord;out float v_alpha;void main(){vec3 A=a_uv*vec3(a_position,1.);vec3 B=a_mvp*vec3(a_position,1.);v_alpha=a_alpha;v_texCoord=A.xy;gl_Position=vec4(B.xy,0.,1.);}`,name:"sprite.vert",inAttributes:{a_position:{type:"vec2"},a_uv:{type:"mat3"},a_mvp:{type:"mat3"},a_alpha:{type:"float"}},outAttributes:{},uniforms:{}},tr=Uo});async function ir(e,t){return await K(e,t.urls.diffuse)}var ye,nr=_(()=>{"use strict";W();ie();Qt();rr();ye=class{#e;#t;#i;#n;#r;#o;#s;constructor(t){this.#e=t.gl,this.#t=new B(t.gl,tr,Jt),this.#i=new q(this.#e,this.#t,{a_mvp:r=>r.mvp,a_uv:r=>r.uv,a_alpha:r=>r.alpha}),this.#n=new C(this.#e),this.#o=[],this.#r=null,this.#s=1}use(t){this.#t.use(()=>{this.#s=1,t(this),this.#h()})}setTextures(t){return t===this.#r?this:(this.#o.length&&this.#h(),this.#r=t,this.#t.setUniforms({u_texture:t}),this)}setAlpha(t){return this.#s=t,this}draw(t,r){if(this.#r){let i=x.create();x.translate(i,i,[t[3],t[0]]),x.scale(i,i,[t[1]-t[3],t[2]-t[0]]),x.multiply(i,X,i);let n=x.create();x.translate(n,n,[r[3]/this.#r.width,r[0]/this.#r.height]),x.scale(n,n,[(r[1]-r[3])/this.#r.width,(r[2]-r[0])/this.#r.height]),this.#o.push({mvp:i,uv:n,alpha:this.#s})}return this}#h(){this.#n.bindInstances(this.#t,{position:"a_position"},this.#i.load(this.#o),t=>{t.draw()}),this.#o=[],this.#r=null}}});var or,Oo,sr,ar=_(()=>{"use strict";or||(or={});Oo={src:`#version 300 es
precision mediump float;uniform vec2 u_border;in vec2 v_localPosition;in vec4 v_bounds;in vec4 v_fillColor;in vec4 v_borderColor;out vec4 outColor;void main(){vec2 A=v_localPosition;if(A.x<v_bounds.w+u_border.x||A.y<v_bounds.x+u_border.y||A.x>v_bounds.y-u_border.x||A.y>v_bounds.z-u_border.y){outColor=v_borderColor;}else{outColor=v_fillColor;}}`,name:"solid.frag",inAttributes:{},outAttributes:{outColor:{type:"vec4"}},uniforms:{u_border:"vec2"}},sr=Oo});var hr,ko,cr,lr=_(()=>{"use strict";hr||(hr={});ko={src:`#version 300 es
uniform mat3 u_vp;in vec2 a_position;in vec4 a_fillColor;in vec4 a_borderColor;in mat3 a_m;in vec4 a_bounds;out vec2 v_localPosition;out vec4 v_bounds;out vec4 v_fillColor;out vec4 v_borderColor;void main(){vec3 A=a_m*vec3(a_position,1.);vec3 B=u_vp*A;v_localPosition=A.xy;v_bounds=a_bounds;v_fillColor=a_fillColor;v_borderColor=a_borderColor;gl_Position=vec4(B.xy,0.,1.);}`,name:"solid.vert",inAttributes:{a_position:{type:"vec2"},a_fillColor:{type:"vec4"},a_borderColor:{type:"vec4"},a_m:{type:"mat3"},a_bounds:{type:"vec4"}},outAttributes:{},uniforms:{u_vp:"mat3"}},cr=ko});var Ae,fr=_(()=>{"use strict";W();ie();ar();lr();Ae=class{#e;#t;#i;#n;#r;constructor(t){this.#e=t.gl,this.#t=new B(t.gl,cr,sr),this.#i=new q(this.#e,this.#t,{a_m:r=>r.m,a_bounds:r=>r.bounds,a_fillColor:r=>r.fillColor,a_borderColor:r=>r.borderColor}),this.#n=new C(this.#e),this.#r=[]}use(t){this.#t.use(()=>{this.#t.setUniforms({u_border:g.fromValues(0,0),u_vp:X}),t(this),this.#o()})}setBorder(t,r){this.#t.setUniforms({u_border:g.fromValues(r/t.width,r/t.height)})}draw(t,r,i){let n=x.create();return x.translate(n,n,[t[3],t[0]]),x.scale(n,n,[t[1]-t[3],t[2]-t[0]]),this.#r.push({m:n,bounds:w.clone(t),fillColor:r,borderColor:i||r}),this}#o(){this.#n.bindInstances(this.#t,{position:"a_position"},this.#i.load(this.#r),t=>t.draw()),this.#r=[]}}});var ur,dr=_(()=>{"use strict";(function(e){e[e.KERNEL_SIZE=9]="KERNEL_SIZE"})(ur||(ur={}))});var mr,Go,de,Ie=_(()=>{"use strict";mr||(mr={});Go={src:`#version 300 es
in vec2 a_position;out vec2 v_texCoord;void main(){v_texCoord=a_position;gl_Position=vec4(a_position*2.-1.,0.,1.);}`,name:"quad.vert",inAttributes:{a_position:{type:"vec2"}},outAttributes:{},uniforms:{}},de=Go});var pr=_(()=>{"use strict";W();dr();Ie()});var vr=_(()=>{"use strict";Kt();nr();fr();pr()});var zo,gr,_r=_(()=>{"use strict";zo={name:"overworld",sprites:{grass_b:{index:1,width:16,height:16,frames:[{top:224,left:0,bottom:208,right:16}]},grass_bl:{index:2,width:16,height:16,frames:[{top:208,left:0,bottom:192,right:16}]},grass_br:{index:3,width:16,height:16,frames:[{top:192,left:0,bottom:176,right:16}]},grass_i_bl:{index:4,width:16,height:16,frames:[{top:176,left:0,bottom:160,right:16}]},grass_i_br:{index:5,width:16,height:16,frames:[{top:160,left:0,bottom:144,right:16}]},grass_t:{index:6,width:16,height:16,frames:[{top:144,left:0,bottom:128,right:16}]},grass_tl:{index:7,width:16,height:16,frames:[{top:128,left:0,bottom:112,right:16}]},grass_tr:{index:8,width:16,height:16,frames:[{top:112,left:0,bottom:96,right:16}]},grass_i_tl:{index:9,width:16,height:16,frames:[{top:96,left:0,bottom:80,right:16}]},grass_i_tr:{index:10,width:16,height:16,frames:[{top:80,left:0,bottom:64,right:16}]},grass_l:{index:11,width:16,height:16,frames:[{top:64,left:0,bottom:48,right:16}]},grass_r:{index:12,width:16,height:16,frames:[{top:48,left:0,bottom:32,right:16}]},grass:{index:13,width:16,height:16,frames:[{top:32,left:0,bottom:16,right:16},{top:32,left:16,bottom:16,right:32},{top:32,left:32,bottom:16,right:48},{top:32,left:48,bottom:16,right:64}]},water:{index:14,width:16,height:16,frames:[{top:16,left:0,bottom:0,right:16},{top:16,left:16,bottom:0,right:32},{top:16,left:32,bottom:0,right:48},{top:16,left:48,bottom:0,right:64},{top:16,left:64,bottom:0,right:80},{top:16,left:80,bottom:0,right:96},{top:16,left:96,bottom:0,right:112},{top:16,left:112,bottom:0,right:128}]}},indexes:["","grass_b","grass_bl","grass_br","grass_i_bl","grass_i_br","grass_t","grass_tl","grass_tr","grass_i_tl","grass_i_tr","grass_l","grass_r","grass","water"],urls:{diffuse:"/sprites/overworld-diffuse.png?v=0f8c2ff20f23384811f70a22403a972cf8c3e7c72e07dadafce582ce58018e37",emissive:"/sprites/overworld-emissive.png?v=7e964b09ced6bc0c687bf7ecdb19a52cb3292c73da1ab2b7ef5d5a58b36ddfaa",normal:"/sprites/overworld-normal.png?v=44d5501815dee57e4abd24590a5d30c80358dd2bdb90e0da5d8a9c4fbd1b6c5f",specular:"/sprites/overworld-specular.png?v=55f7d8c380b7ae96744f2a603c471cac28960f274676126a554b1600db787175"}},gr=zo});var Vo,ne,xr=_(()=>{"use strict";_r();Vo={width:100,height:100,startPosition:{x:10,y:10},spriteSheet:"overworld",version:"a68b7830972bce04b3310c5aed3acf5fa734e922fc3eceef06abc07fee6a13d7",url:"/maps/overworld.png?v=a68b7830972bce04b3310c5aed3acf5fa734e922fc3eceef06abc07fee6a13d7",name:"overworld",spriteSheet:gr},ne=Vo});var Yo,br,Er=_(()=>{"use strict";Yo={src:`#version 300 es
precision mediump float;uniform sampler2D u_blur;uniform vec2 u_blurSize;uniform vec2 u_blurDirection;uniform float u_blurStrength;in vec2 v_texCoord;out vec4 o_color;const int A=16;void main(){float B=texture(u_blur,v_texCoord).a;vec3 C=vec3(0.);for(int D=0;D<A;++D){vec2 E=v_texCoord+((vec2(-D,-D)*u_blurDirection)/u_blurSize);vec4 F=texture(u_blur,E);float G=F.a*pow(float(A-D)/float(A),u_blurStrength);B=max(B,G);C=length(C)<length(F.rgb)?F.rgb:C;vec2 H=v_texCoord+((vec2(D,D)*u_blurDirection)/u_blurSize);vec4 I=texture(u_blur,H);float J=I.a*pow(float(A-D)/float(A),u_blurStrength);B=max(B,J);C=length(C)<length(I.rgb)?I.rgb:C;}o_color=vec4(C,B);}`,name:"nearest-blur.frag",inAttributes:{},outAttributes:{o_color:{type:"vec4"}},uniforms:{u_blur:"sampler2D",u_blurSize:"vec2",u_blurDirection:"vec2",u_blurStrength:"float"}},br=Yo});var Re,wr=_(()=>{"use strict";W();Ie();Er();Re=class{#e;#t;#i;#n;constructor(t){this.#e=t.gl,this.#t=new B(t.gl,de,br),this.#i=new C(this.#e),this.#n=null}draw(t,r){if(!this.#n||this.#n.textures[0].width!==t.width||this.#n.textures[0].height!==t.height){let o=[];for(let s=0;s<2;s++)o.push({[y]:xe(this.#e,this.#e.RGBA,this.#e.RGBA,this.#e.UNSIGNED_BYTE,t.width,t.height),width:t.width,height:t.height});this.#n={textures:o,frameBuffers:[new O(this.#e,this.#t,{o_color:o[0]}),new O(this.#e,this.#t,{o_color:o[1]})]}}let i=this.#e.getParameter(this.#e.BLEND);this.#e.disable(this.#e.BLEND);let n=this.#n;return this.#t.use(o=>{this.#e.viewport(0,0,t.width,t.height),o.setUniforms({u_blur:t[y],u_blurSize:[t.width,t.height],u_blurDirection:[0,1],u_blurStrength:r}),n.frameBuffers[0].bind(()=>{this.#e.clear(this.#e.COLOR_BUFFER_BIT|this.#e.DEPTH_BUFFER_BIT),this.#i.bind(this.#t,{position:"a_position"},s=>{s.draw()})}),o.setUniforms({u_blur:n.textures[0][y],u_blurSize:[n.textures[0].width,n.textures[0].height],u_blurDirection:[1,0]}),n.frameBuffers[1].bind(()=>{this.#e.clear(this.#e.COLOR_BUFFER_BIT|this.#e.DEPTH_BUFFER_BIT),this.#i.bind(this.#t,{position:"a_position"},s=>{s.draw()})}),this.#e.viewport(0,0,t.width,t.height)}),i&&this.#e.enable(this.#e.BLEND),this}getBlurTexture(){return this.#n.textures[1]}}});var Ho,Tr,Mr=_(()=>{"use strict";Ho={name:"character",sprites:{walk_d:{index:1,width:16,height:32,frames:[{top:128,left:0,bottom:96,right:16},{top:128,left:16,bottom:96,right:32},{top:128,left:32,bottom:96,right:48},{top:128,left:48,bottom:96,right:64}]},walk_u:{index:2,width:16,height:32,frames:[{top:96,left:0,bottom:64,right:16},{top:96,left:16,bottom:64,right:32},{top:96,left:32,bottom:64,right:48},{top:96,left:48,bottom:64,right:64}]},walk_l:{index:3,width:16,height:32,frames:[{top:64,left:0,bottom:32,right:16},{top:64,left:16,bottom:32,right:32},{top:64,left:32,bottom:32,right:48},{top:64,left:48,bottom:32,right:64}]},walk_r:{index:4,width:16,height:32,frames:[{top:32,left:0,bottom:0,right:16},{top:32,left:16,bottom:0,right:32},{top:32,left:32,bottom:0,right:48},{top:32,left:48,bottom:0,right:64}]}},indexes:["","walk_d","walk_u","walk_l","walk_r"],urls:{diffuse:"/sprites/character-diffuse.png?v=26b65f0388e68f1215898c95b2eb5ebc38671434ad2b744b91c31a089630061f",emissive:"/sprites/character-emissive.png?v=269513c7efa74adea87bfedc176d2edce2df1c754a8fbcc31665f1a9a0238bf0",normal:"/sprites/character-normal.png?v=5564d03c4253751462f1379a60c9abcf48ce0dc122efb197b636402f59502e86",specular:"/sprites/character-specular.png?v=95699c39d4b7ad9a82ce1258ae71017af7b1be063056ae756702429b6683c859"}},Tr=Ho});var qo,Sr,yr=_(()=>{"use strict";qo={name:"ui",sprites:{touch:{index:1,width:64,height:64,frames:[{top:64,left:0,bottom:0,right:64}]}},indexes:["","touch"],urls:{diffuse:"/sprites/ui-diffuse.png?v=e5957b7c38c750fbb5ed223b2286211e7e7ebe6d4ca66960527a40ad4caf79a9",emissive:"/sprites/ui-emissive.png?v=ebb17149ce1cf937cadfb8e903b2812b9a0ecc366eb7705e40e3c73461dc082f",normal:"/sprites/ui-normal.png?v=cbc9c3b8b286807faad22c32142729281692bad97abd6edab4499e8248d68cb8",specular:"/sprites/ui-specular.png?v=01c6ec306f27fa4865bd1f3105fca42b0b9da17a429013e82bf32f1bf88a1944"}},Sr=qo});var Xo,Ar,Ir=_(()=>{"use strict";Xo={src:`#version 300 es
precision mediump float;layout(location=0)out vec4 o_normal;layout(location=1)out vec4 o_albedo;layout(location=2)out vec4 o_specular;layout(location=3)out vec4 o_lighting;layout(location=4)out vec4 o_mask;in vec2 v_texCoord;uniform sampler2D u_mask;uniform sampler2D u_depth;uniform float u_time;uniform vec2 u_scale;uniform vec2 u_offset;uniform vec3 u_normal;uniform vec3 u_tangent;uniform vec3 u_binormal;uniform mat3 u_toTangentSpace;const float A=acos(-1.);const vec2 B=vec2(1.,0.);const int C=12;const float D=1000.;const float E=0.06;float F(vec2 G){return fract(sin(dot(G.xy,vec2(12.9898,78.233)))*43758.5453);}void H(in int I,out float J,out float K,out vec2 L,out float M,out float N){J=abs(0.05*F(vec2(I,I)));K=.02+.01*F(vec2(float(I+5)));L=(vec2(F(vec2(I,I+1)),F(vec2(I-2,I+2))));M=30.+82.*F(vec2(float(I+5)));N=(2.5+4.2*F(vec2(float(I+4))))*0.00045;}float O(float P){return round(P*D)/D;}void Q(in vec2 R,in float S,in float T,out vec3 U,out vec3 V){U=vec3(R,0.);V=B.yyy;float J,M,N,K;vec2 L;for(int I=0;I<C;++I){H(I,J,K,L,M,N);J+=S*0.1;K+=S*0.3;float W=dot(L,R);U+=vec3(J*K*L*cos(M*W+O(N)*T*A*2.),K*sin(M*W+O(N)*T*A*2.));}for(int I=0;I<C;++I){H(I,J,K,L,M,N);V+=vec3(-L*M*K*cos(M*dot(L,U.xy)+O(N)*T*A*2.),1.-J*M*K*sin(M*dot(L,U.xy)+O(N)*T*A*2.));}V=normalize(V);}void main(){vec2 X=v_texCoord*u_scale*E;vec2 Y=u_offset*u_scale*E;vec4 Z=texture(u_mask,v_texCoord);vec4 a=texture(u_depth,v_texCoord);float S=smoothstep(0.,1.,a.a);float b=1.-Z.a;vec3 c=B.yyx,d=1.*B.xyy,e=1.*B.yxy+B.yyx,W=normalize(cross(e,d)),f=c+(X.x+Y.x)*d+(X.y+Y.y)*e;vec3 g=(B.yyx-3.*B.yxy),h=mat3(B.yxy,B.yyx,1./W.z,-W.x/W.z,-W.y/W.z)*f,i,U;Q(h.xy,S,u_time,U,i);vec3 j=normalize(cross(i.x*u_normal+u_binormal,i.y*u_normal+u_tangent))*u_toTangentSpace;o_albedo=vec4(50./255.+S*0.5,124./255.+S*0.5,U.z/255.+224./255.+S,b);if(S<0.99){vec4 k=texture(u_depth,X-i.xy*4.);if(k.r>0.001){o_albedo=vec4(k.rgb*S/2.+o_albedo.rgb*(1.-S/2.),b);}}o_normal=vec4(j,b);o_specular=vec4(1.,1.,1.,b);o_lighting=vec4(0.,0.,0.,0.);o_mask=vec4(0.,0.,0.,0.);}`,name:"water.frag",inAttributes:{},outAttributes:{o_normal:{type:"vec4",location:0},o_albedo:{type:"vec4",location:1},o_specular:{type:"vec4",location:2},o_lighting:{type:"vec4",location:3},o_mask:{type:"vec4",location:4}},uniforms:{u_mask:"sampler2D",u_depth:"sampler2D",u_time:"float",u_scale:"vec2",u_offset:"vec2",u_normal:"vec3",u_tangent:"vec3",u_binormal:"vec3",u_toTangentSpace:"mat3"}},Ar=Xo});var Pe,Rr=_(()=>{"use strict";W();ie();Ie();Ir();Pe=class{#e;#t;#i;constructor(t){this.#e=t.gl,this.#t=new B(t.gl,de,Ar),this.#i=new C(this.#e)}draw(t,r,i,n,o){return this.#t.use(s=>{s.setUniforms({u_normal:te,u_tangent:ee,u_binormal:he,u_toTangentSpace:Ee,u_time:t,u_scale:g.fromValues(i.width/E.TILE_SIZE,i.height/E.TILE_SIZE),u_offset:r,u_mask:n[y],u_depth:o[y]}),this.#i.bind(this.#t,{position:"a_position"},a=>{a.draw()})}),this}}});var Lr={};Z(Lr,{default:()=>Be});var Le,De,Pr,V,Be,Dr=_(()=>{"use strict";W();ie();vr();xr();wr();Mr();yr();Rr();Le=.25,De=5,Pr=2,V=1e3,Be=class{constructor(){}onStart(t,r){if(r&&r.version!==Pr)throw new Error(`Invalid save version ${r.version}`);return{spriteEffect:new Se(t),simpleSpriteEffect:new ye(t),solidEffect:new Ae(t),resources:new Te({ui:le(t,Sr,ir),map:Ft(t,E.TILE_SIZE,ne,Ve),character:(async()=>{let n=await le(t,Tr,Ve);return{sprite:n,animator:new Me(n,r?r.character.direction:"walk_d",8/1e3),position:r&&r.mapVersion===ne.version?g.fromValues(r.character.position[0],r.character.position[1]):g.fromValues(ne.startPosition.x*E.TILE_SIZE,ne.startPosition.y*E.TILE_SIZE),relativePosition:g.create(),boundingBox:w.fromValues(n.walk_u.height-14,n.walk_u.width-2,n.walk_u.height-4,2),speed:1}})()}),waterEffect:new Pe(t),blurEffect:new Re(t),animationTimer:0,screen:{absolutePosition:g.create()},moveTouch:null,directionalLighting:[],day:0}}onSave(t){let r=null;return t.resources.ifReady(i=>{r={version:Pr,mapVersion:ne.version,character:{position:[i.character.position[0],i.character.position[1]],direction:i.character.animator.getSpriteName()}}}),r}onUpdate(t,r,i){r.resources.ifReady(s=>{let a={},c=t.getGamepad();c&&((c.buttons[12].pressed||Math.min(0,c.axes[1]+Le)<0)&&(a.up=!0),(c.buttons[13].pressed||Math.max(0,c.axes[1]-Le)>0)&&(a.down=!0),(c.buttons[14].pressed||Math.min(0,c.axes[0]+Le)<0)&&(a.left=!0),(c.buttons[15].pressed||Math.max(0,c.axes[0]-Le)>0)&&(a.right=!0)),t.keys.pressed.has("f")&&t.keys.down.has("Control")&&(document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():t.canvas.requestFullscreen()),(t.keys.down.has("w")||t.keys.down.has("ArrowUp"))&&(a.up=!0),(t.keys.down.has("s")||t.keys.down.has("ArrowDown"))&&(a.down=!0),(t.keys.down.has("a")||t.keys.down.has("ArrowLeft"))&&(a.left=!0),(t.keys.down.has("d")||t.keys.down.has("ArrowRight"))&&(a.right=!0);for(let[v,d]of t.touches.down)r.moveTouch===null&&Date.now()-d.started>250&&(r.moveTouch={id:v,startPosition:g.clone(d.position)});for(let[v,d]of t.touches.ended)r.moveTouch!==null&&v===r.moveTouch.id&&(r.moveTouch=null);if(r.moveTouch!==null){let v=t.touches.down.get(r.moveTouch.id);v?(v.position[0]-r.moveTouch.startPosition[0]<-De&&(a.left=!0),v.position[0]-r.moveTouch.startPosition[0]>De&&(a.right=!0),v.position[1]-r.moveTouch.startPosition[1]<-De&&(a.up=!0),v.position[1]-r.moveTouch.startPosition[1]>De&&(a.down=!0)):r.moveTouch=null}let h=null;a.left?h="walk_l":a.right?h="walk_r":a.up?h="walk_u":a.down&&(h="walk_d"),h&&s.character.animator.setSpriteOrTick(h,i),r.animationTimer+=i/10,r.animationTimer>V&&(r.animationTimer-=V);let l=g.create();a.left&&l[0]--,a.right&&l[0]++,a.up&&l[1]--,a.down&&l[1]++,g.normalize(l,l),g.scale(l,l,s.character.speed),g.add(l,l,s.character.position);let u=g.fromValues(s.character.animator.getSprite().width/2,s.character.animator.getSprite().height/2);if(s.map.data.read(Math.floor((l[0]-u[0]+s.character.boundingBox[3])/E.TILE_SIZE),Math.floor((l[1]-u[1]+s.character.boundingBox[0])/E.TILE_SIZE)).walkable&&s.map.data.read(Math.floor((l[0]-u[0]+s.character.boundingBox[1])/E.TILE_SIZE),Math.floor((l[1]-u[1]+s.character.boundingBox[0])/E.TILE_SIZE)).walkable&&s.map.data.read(Math.floor((l[0]-u[0]+s.character.boundingBox[3])/E.TILE_SIZE),Math.floor((l[1]-u[1]+s.character.boundingBox[2])/E.TILE_SIZE)).walkable&&s.map.data.read(Math.floor((l[0]-u[0]+s.character.boundingBox[1])/E.TILE_SIZE),Math.floor((l[1]-u[1]+s.character.boundingBox[2])/E.TILE_SIZE)).walkable){let v=g.fromValues(s.character.animator.getSprite().width/2,s.character.animator.getSprite().height/2),d=g.fromValues(s.map.data.width*E.TILE_SIZE,s.map.data.height*E.TILE_SIZE);g.subtract(d,d,v),g.min(s.character.position,l,d),g.max(s.character.position,s.character.position,v)}s.character.relativePosition[0]=s.character.position[0]<t.screen.width/2?s.character.position[0]:s.character.position[0]>s.map.data.width*E.TILE_SIZE-t.screen.width/2?s.character.position[0]-s.map.data.width*E.TILE_SIZE+t.screen.width:t.screen.width/2,s.character.relativePosition[1]=s.character.position[1]<t.screen.height/2?s.character.position[1]:s.character.position[1]>s.map.data.height*E.TILE_SIZE-t.screen.height/2?s.character.position[1]-s.map.data.height*E.TILE_SIZE+t.screen.height:t.screen.height/2,g.subtract(r.screen.absolutePosition,s.character.position,s.character.relativePosition),s.map.data.updateScreenBuffer(t,r.screen.absolutePosition)});let n=Math.sin(r.animationTimer);n=Math.min(1,n+.5),r.day=r.animationTimer<V*.25?re.smoothstep(0,V*.25,r.animationTimer):r.animationTimer<V*.5?1:r.animationTimer<V*.75?1-re.smoothstep(V*.5,V*.75,r.animationTimer):0;let o=Math.cos(Math.min(r.animationTimer,V*.75)*Math.PI/(V*.75));r.directionalLighting=[{ambient:P.fromValues(.2+r.day*.3,.2+r.day*.3,.4+r.day*.1),direction:P.fromValues(o,r.day*.3+.2,-1),diffuse:P.fromValues(Math.pow(r.day,.25)*(1-r.day)+r.day*.5,r.day*.5,r.day*.45)},{ambient:P.create(),direction:P.fromValues(0,(1-r.day)*.5,-1),diffuse:P.fromValues((1-r.day)*.2,(1-r.day)*.2,(1-r.day)*.2)}]}onDraw(t,r,i){t.gl.enable(t.gl.BLEND),t.gl.blendFunc(t.gl.SRC_ALPHA,t.gl.ONE_MINUS_SRC_ALPHA);let n=E.toAbsoluteTileFromAbsolute(w.create(),r.screen.absolutePosition);for(let o of r.directionalLighting)r.spriteEffect.addDirectionalLight(o);r.spriteEffect.addPointLight({diffuse:P.fromValues(.6*(1-r.day),.6*(1-r.day),.3*(1-r.day)),position:P.fromValues(t.mouse.position[0]/t.screen.width,t.mouse.position[1]/t.screen.height,.1),radius:.5}).use({width:t.screen.width,height:t.screen.height},(o,s)=>{r.resources.ifReady(a=>{let c=(t.screen.width+2*E.TILE_SIZE)/E.TILE_SIZE,h=(t.screen.height+2*E.TILE_SIZE)/E.TILE_SIZE;if(s===0)for(let l=-1;l<=c;++l)for(let u=-1;u<=h;++u){let m=l+n[0],v=u+n[1],d=t.screen.toScreenSpace(w.create(),w.fromValues(u*E.TILE_SIZE-n[3],l*E.TILE_SIZE+E.TILE_SIZE-n[2],u*E.TILE_SIZE+E.TILE_SIZE-n[3],l*E.TILE_SIZE-n[2])),M=a.map.data.read(m,v);if(M.index!==0){let A=a.map.spriteConfig.indexes[M.index];a.map.sprite[A].draw(o,d,M.spatialHash?re.hash(m,v):void 0)}}else{let l=g.fromValues(a.character.animator.getSprite().width/2,a.character.animator.getSprite().height/2);a.character.animator.draw(o,t.screen.toScreenSpace(w.create(),w.fromValues(Math.floor(a.character.relativePosition[1])-l[1],Math.floor(a.character.relativePosition[0])+l[0],Math.floor(a.character.relativePosition[1])+l[1],Math.floor(a.character.relativePosition[0])-l[0])))}})},o=>{let s=g.clone(r.screen.absolutePosition);g.div(s,s,g.fromValues(t.screen.width,t.screen.height)),r.blurEffect.draw(o,3),r.waterEffect.draw(r.animationTimer,s,t.screen,o,r.blurEffect.getBlurTexture())}),r.simpleSpriteEffect.use(o=>{let s=r.spriteEffect.getLightingTexture();if(s&&(o.setTextures(s),o.draw(w.fromValues(0,1,1,0),w.fromValues(0,s.width,s.height,0))),r.moveTouch!==null){let a=r.moveTouch;o.setAlpha(.5),r.resources.ifReady(c=>{c.ui.touch.draw(o,t.screen.toScreenSpace(w.create(),w.fromValues(Math.round(a.startPosition[1])-32,Math.round(a.startPosition[0])+32,Math.round(a.startPosition[1])+32,Math.round(a.startPosition[0])-32)))})}})}}});$();Ne();Ue();be();be();J();we();var To={src:`#version 300 es
in vec2 a_position;
out vec2 v_texCoord;
void main() {
  v_texCoord = a_position;
  gl_Position = vec4(a_position * 2.0 - 1.0, 0.0, 1.0);
}`,name:"quad.vert",inAttributes:{a_position:{type:"vec2"}},outAttributes:{v_texCoord:{type:"vec2"}},uniforms:{}},Mo={src:`#version 300 es
precision mediump float;
in vec2 v_texCoord;
uniform sampler2D u_texture;
out vec4 outColor;
void main() {
  outColor = texture(u_texture, v_texCoord);
}`,name:"backbuffer.frag",inAttributes:{v_texCoord:{type:"vec2"}},outAttributes:{outColor:{type:"vec4"}},uniforms:{u_texture:"sampler2D"}};function ke(e){let t=e.game,r=e.editor,i=document.createElement("canvas");i.style.position="relative",i.style.transform="scaleY(-1)";let n=i.getContext("bitmaprenderer"),o=new Oe,s={width:1,height:1},a={offsetLeft:0,offsetTop:0,width:1,height:1},c=null,h={gl:o.gl,editorServer:new pe,createRenderTarget:(f,p)=>{let b=document.createElement("canvas");return b.width=f,b.height=p,b.getContext("bitmaprenderer")},canvas:i,getGamepad:()=>c!==null?navigator.getGamepads()[c]:null,keys:{down:new Set,pressed:new Set},mouse:{position:g.create(),wheel:g.create(),down:[],clicked:[]},touches:{down:new Map,ended:new Map},screen:{get width(){return s.width},get height(){return s.height},safeArea:{get width(){return s.width},get height(){return s.height},get boundingRect(){return w.fromValues(a.offsetTop,a.offsetLeft+a.width,a.offsetTop+a.height,a.offsetLeft)}},toScreenSpace:(f,p)=>w.set(f,p[0]/s.height,p[1]/s.width,p[2]/s.height,p[3]/s.width)}},l=1;window.addEventListener("gamepadconnected",f=>{c=f.gamepad.index}),window.addEventListener("gamepaddisconnected",f=>{c=null}),window.addEventListener("keydown",f=>{h.keys.down.add(f.key),(f.altKey||f.shiftKey||f.ctrlKey)&&f.preventDefault()}),window.addEventListener("keyup",f=>{h.keys.down.has(f.key)&&h.keys.pressed.add(f.key),h.keys.down.delete(f.key),(f.altKey||f.shiftKey||f.ctrlKey)&&f.preventDefault()}),i.addEventListener("wheel",f=>{f.deltaMode===WheelEvent.DOM_DELTA_PIXEL&&g.set(h.mouse.wheel,f.deltaX,f.deltaY)}),i.addEventListener("mousemove",f=>{let p=i.getBoundingClientRect();g.set(h.mouse.position,(f.clientX-p.left)/l,(f.clientY-p.top)/l)}),i.addEventListener("mousedown",f=>{h.mouse.down[f.button]=!0}),i.addEventListener("mouseup",f=>{h.mouse.down[f.button]&&(h.mouse.clicked[f.button]=!0),h.mouse.down[f.button]=!1}),i.addEventListener("contextmenu",f=>{f.preventDefault()}),i.addEventListener("touchstart",f=>{let p=i.getBoundingClientRect();for(let b=0;b<f.changedTouches.length;++b){let T=f.changedTouches[b],S=g.fromValues((T.clientX-p.left)/l,(T.clientY-p.top)/l);S[0]>=0&&S[1]>=0&&S[0]<=h.screen.width&&S[1]<=h.screen.height&&h.touches.down.set(T.identifier,{started:Date.now(),position:S})}f.preventDefault()}),i.addEventListener("touchmove",f=>{let p=i.getBoundingClientRect();for(let b=0;b<f.changedTouches.length;++b){let T=f.changedTouches[b],S=h.touches.down.get(T.identifier);S&&g.set(S.position,(T.clientX-p.left)/l,(T.clientY-p.top)/l)}f.preventDefault()}),i.addEventListener("touchend",f=>{let p=i.getBoundingClientRect();for(let b=0;b<f.changedTouches.length;++b){let T=f.changedTouches[b],S=h.touches.down.get(T.identifier);S&&(g.set(S.position,(T.clientX-p.left)/l,(T.clientY-p.top)/l),h.touches.down.delete(T.identifier),h.touches.ended.set(T.identifier,{position:S.position}))}f.preventDefault()}),i.addEventListener("touchcancel",f=>{for(let p=0;p<f.changedTouches.length;++p){let b=f.changedTouches[p];h.touches.down.get(b.identifier)&&h.touches.down.delete(b.identifier)}f.preventDefault()});let u=performance.now(),m=()=>{let f=localStorage.getItem(e.saveKey),p=localStorage.getItem(`${e.saveKey}-editor`);u=performance.now();let b=(()=>{try{return t.onStart(h,f?JSON.parse(f):void 0)}catch(S){return console.warn(S),t.onStart(h)}})(),T=r?(()=>{try{return r?.onEnd(h,e.container),r?.onStart(h,b,e.container,p?JSON.parse(p):void 0)}catch(S){return console.warn(S),r?.onEnd(h,e.container),r?.onStart(h,b,e.container)}})():null;return{gameState:b,editorState:T}};if(h.editorServer.listen(f=>{switch(f.type){case"RELOAD_SHADER":{Tt(f.shader,f.src);break}case"RELOAD_SPRITESHEET":{Et(f.spriteSheet),yt(f.spriteSheet);break}case"RELOAD_STATIC":{let p=document.head.querySelectorAll("link");for(let b of p){let T=b.getAttribute("href"),S=T?.split("?")[0],H=S?f.resources[S]:null;if(H&&T!==H){console.log(`Reloading stylesheet ${S}...`);let G=document.createElement("link");G.rel="stylesheet",G.href=H,G.onload=()=>{document.head.removeChild(b)},document.head.appendChild(G)}}}}}),r){let f=1;new EventSource("/esbuild").addEventListener("change",p=>{if(JSON.parse(p.data).updated.find(T=>T==="/js/entrypoint.js")){console.log("Saving state before reloading game plugin...");let T=t.onSave(d.gameState);T&&localStorage.setItem(e.saveKey,JSON.stringify(T)),import("/js/entrypoint.js?v="+f++).then(S=>{t=S.createGameClient(),console.log("Reloaded game plugin.")})}})}let v=!1,d={...m(),canvas:i};i.addEventListener("webglcontextlost",f=>{f.preventDefault(),v=!0,console.warn("WebGL context lost, saving state..."),d.gameState&&localStorage.setItem(e.saveKey,JSON.stringify(t.onSave(d.gameState))),d.editorState&&r&&localStorage.setItem(`${e.saveKey}-editor`,JSON.stringify(r.onSave(d.editorState)))},!1),i.addEventListener("webglcontextrestored",f=>{f.preventDefault(),h.gl=i.getContext("webgl2"),console.warn("WebGL context restored, loading state..."),Object.keys(d.gameState).forEach(p=>{delete d.gameState[p]}),d.editorState&&Object.keys(d.editorState).forEach(p=>{delete d.editorState[p]}),Object.assign(d,m()),v=!1},!1);let M=i.parentElement,A=0,I=null,k=(f,p)=>{let b=f.canvas.width,T=f.canvas.height;"style"in f.canvas&&(f.canvas.style.transform="scaleY(-1)"),f.transferFromImageBitmap(o.use({width:b,height:T},p))},F=()=>{if(M){let f=performance.now(),p=f-u;for(u=f,A+=p;A>=e.fixedUpdate;)t.onUpdate(h,d.gameState,e.fixedUpdate),d.editorState&&r?.onUpdate(h,d.gameState,d.editorState,e.fixedUpdate),h.mouse.clicked=[],g.set(h.mouse.wheel,0,0),h.touches.ended.clear(),h.keys.pressed.clear(),A-=e.fixedUpdate;if(!v){let b=o.useScaled(h.screen,l,()=>{t.onDraw(h,d.gameState,p),d.editorState&&r?.onDraw(h,d.gameState,d.editorState,p)});n.transferFromImageBitmap(b),d.editorState&&r?.onDrawExtra(h,d.gameState,d.editorState,p,k)}}I=requestAnimationFrame(F)};I=requestAnimationFrame(F);let Y=()=>{if(document.visibilityState==="hidden"){console.warn("Visibility changing, saving state...");let f=t.onSave(d.gameState);if(f&&localStorage.setItem(e.saveKey,JSON.stringify(f)),d.editorState){let p=r?.onSave(d.editorState);p&&localStorage.setItem(`${e.saveKey}-editor`,JSON.stringify(p))}I&&cancelAnimationFrame(I)}else u=performance.now(),A=0,I=requestAnimationFrame(F)};window.addEventListener("visibilitychange",Y);let oe=()=>{let f=i.parentElement||e.container;if(l=1,f.clientWidth>=f.clientHeight){for(s.width=Math.min(e.screen.preferredWidthIncrements,Math.floor(f.clientWidth/e.screen.incrementSize))*e.screen.incrementSize;s.width*(l+1)<f.clientWidth;)++l;s.height=Math.floor(f.clientHeight/(e.screen.incrementSize*l))*e.screen.incrementSize}else{for(s.height=Math.min(e.screen.preferredHeightIncrements,Math.floor(f.clientHeight/e.screen.incrementSize))*e.screen.incrementSize;s.height*(l+1)<f.clientHeight;)++l;s.width=Math.floor(f.clientWidth/(e.screen.incrementSize*l))*e.screen.incrementSize}for(;s.width*l<f.clientWidth;)s.width+=e.screen.incrementSize;for(;s.height*l<f.clientHeight;)s.height+=e.screen.incrementSize;let p=(s.width-f.clientWidth/l)/2,b=(s.height-f.clientHeight/l)/2;a.offsetLeft=Math.ceil(p),a.offsetTop=Math.ceil(b),a.width=s.width-a.offsetLeft*2,a.height=s.height-a.offsetTop*2,i.style.top=-(l*b)+"px",i.style.left=-(l*p)+"px",i.style.width=i.style.minWidth=l*s.width+"px",i.style.height=i.style.minHeight=l*s.height+"px"},j=new ResizeObserver(f=>{for(let p of f)p.target===M&&oe()});return setInterval(()=>{let f=i.parentElement;f!=M&&(M&&j.unobserve(M),M=f,M&&(oe(),j.observe(M)))},100),d.editorState||e.container.appendChild(i),d}var Oe=class{gl;#e;#t;#i;#n;#r;constructor(){this.#n=null,this.#r=new OffscreenCanvas(1,1),this.gl=this.#r.getContext("webgl2",{alpha:!1,premultipliedAlpha:!1}),this.gl||console.error("Unable to initialize WebGL. Your browser or machine may not support it."),this.#e=new Q(this.gl,{color:{internalFormat:this.gl.RGBA,format:this.gl.RGBA,type:this.gl.UNSIGNED_BYTE,opts:{filter:this.gl.NEAREST}}}),this.#t=new C(this.gl),this.#i=new B(this.gl,To,Mo)}useScaled({width:t,height:r},i,n){if(!t||!r)return null;this.#r.width=t*i,this.#r.height=r*i;let{color:o}=this.#e.use({width:t,height:r},s=>{this.#n=new O(this.gl,{outAttributes:{o_color:{type:"vec4",location:0}}},{o_color:s.color})});return this.gl.viewport(0,0,t,r),this.#n.bind(n),this.gl.viewport(0,0,t*i,r*i),this.#i.use(s=>{s.setUniforms({u_texture:o}),this.#t.bind(s,{position:"a_position"},a=>a.draw())}),this.#r.transferToImageBitmap()}use({width:t,height:r},i){return this.#r.width=t,this.#r.height=r,this.gl.viewport(0,0,t,r),i(),this.#r.transferToImageBitmap()}};function Wo(){return new(Dr(),Ur(Lr)).default}function Zo(){return null}if(!window.__PIXELHEART__){window.__PIXELHEART__=!0;let e=document.getElementById("root");if(e){let t={fixedUpdate:16.666666666666668,saveKey:"pixelheart",game:Wo(),editor:Zo(),screen:{incrementSize:16,preferredWidthIncrements:20,preferredHeightIncrements:13},container:e};ke(t)}}export{Zo as createEditorClient,Wo as createGameClient};
//# sourceMappingURL=entrypoint.js.map
